<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MOM6: mom_offline_transport Module Reference</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">MOM6
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('d1/d36/namespacemom__offline__transport.html','../../');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#nested-classes">Data Types</a> &#124;
<a href="#func-members">Functions/Subroutines</a>  </div>
  <div class="headertitle">
<div class="title">mom_offline_transport Module Reference</div>  </div>
</div><!--header-->
<div class="contents">

<p>Contains routines related to offline transport of tracers.  
<a href="#details">More...</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="nested-classes"></a>
Data Types</h2></td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">type &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d0/d2c/structmom__offline__transport_1_1offline__transport__cs.html">offline_transport_cs</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions/Subroutines</h2></td></tr>
<tr class="memitem:a60b8cb34d18c91e1e965b21b0cc65ce5"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d1/d36/namespacemom__offline__transport.html#a60b8cb34d18c91e1e965b21b0cc65ce5">transport_by_files</a> (G, GV, CS, h_end, eatr, ebtr, uhtr, vhtr, khdt_x, khdt_y, temp, salt, fluxes, do_ale_in)</td></tr>
<tr class="memdesc:a60b8cb34d18c91e1e965b21b0cc65ce5"><td class="mdescLeft">&#160;</td><td class="mdescRight">Controls the reading in 3d mass fluxes, diffusive fluxes, and other fields stored in a previous integration of the online model.  <a href="#a60b8cb34d18c91e1e965b21b0cc65ce5">More...</a><br /></td></tr>
<tr class="separator:a60b8cb34d18c91e1e965b21b0cc65ce5"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a19ed8ea04e4800c60378abffb5757d7c"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d1/d36/namespacemom__offline__transport.html#a19ed8ea04e4800c60378abffb5757d7c">register_diags_offline_transport</a> (Time, diag, CS)</td></tr>
<tr class="memdesc:a19ed8ea04e4800c60378abffb5757d7c"><td class="mdescLeft">&#160;</td><td class="mdescRight">Initialize additional diagnostics required for offline tracer transport.  <a href="#a19ed8ea04e4800c60378abffb5757d7c">More...</a><br /></td></tr>
<tr class="separator:a19ed8ea04e4800c60378abffb5757d7c"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a44091358f321c2eeb97e5542d2176446"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d1/d36/namespacemom__offline__transport.html#a44091358f321c2eeb97e5542d2176446">offline_transport_init</a> (param_file, CS, diabatic_aux_CSp, G, GV)</td></tr>
<tr class="memdesc:a44091358f321c2eeb97e5542d2176446"><td class="mdescLeft">&#160;</td><td class="mdescRight">Initializes the control structure for offline transport and reads in some of the.  <a href="#a44091358f321c2eeb97e5542d2176446">More...</a><br /></td></tr>
<tr class="separator:a44091358f321c2eeb97e5542d2176446"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a277e868a412054fa0cf723b15e32b8a2"><td class="memItemLeft" align="right" valign="top">integer function&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d1/d36/namespacemom__offline__transport.html#a277e868a412054fa0cf723b15e32b8a2">next_modulo_time</a> (inidx, numtime)</td></tr>
<tr class="memdesc:a277e868a412054fa0cf723b15e32b8a2"><td class="mdescLeft">&#160;</td><td class="mdescRight">Calculates the next timelevel to read from the input fields. This allows the 'looping' of the fields.  <a href="#a277e868a412054fa0cf723b15e32b8a2">More...</a><br /></td></tr>
<tr class="separator:a277e868a412054fa0cf723b15e32b8a2"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a5359757456636e62aae1954e7bc54921"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d1/d36/namespacemom__offline__transport.html#a5359757456636e62aae1954e7bc54921">update_h_horizontal_flux</a> (G, GV, uhtr, vhtr, h_pre, h_new)</td></tr>
<tr class="memdesc:a5359757456636e62aae1954e7bc54921"><td class="mdescLeft">&#160;</td><td class="mdescRight">This updates thickness based on the convergence of horizontal mass fluxes NOTE: Only used in non-ALE mode.  <a href="#a5359757456636e62aae1954e7bc54921">More...</a><br /></td></tr>
<tr class="separator:a5359757456636e62aae1954e7bc54921"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a60a9bf9d4ab918807053d21f973ed6f0"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d1/d36/namespacemom__offline__transport.html#a60a9bf9d4ab918807053d21f973ed6f0">update_h_vertical_flux</a> (G, GV, ea, eb, h_pre, h_new)</td></tr>
<tr class="memdesc:a60a9bf9d4ab918807053d21f973ed6f0"><td class="mdescLeft">&#160;</td><td class="mdescRight">Updates layer thicknesses due to vertical mass transports NOTE: Only used in non-ALE configuration.  <a href="#a60a9bf9d4ab918807053d21f973ed6f0">More...</a><br /></td></tr>
<tr class="separator:a60a9bf9d4ab918807053d21f973ed6f0"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a2a5e42b28ad3cc833ecb0b65de75e454"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d1/d36/namespacemom__offline__transport.html#a2a5e42b28ad3cc833ecb0b65de75e454">limit_mass_flux_3d</a> (G, GV, uh, vh, ea, eb, h_pre, max_off_cfl)</td></tr>
<tr class="memdesc:a2a5e42b28ad3cc833ecb0b65de75e454"><td class="mdescLeft">&#160;</td><td class="mdescRight">This routine limits the mass fluxes so that the a layer cannot be completely depleted. NOTE: Only used in non-ALE mode.  <a href="#a2a5e42b28ad3cc833ecb0b65de75e454">More...</a><br /></td></tr>
<tr class="separator:a2a5e42b28ad3cc833ecb0b65de75e454"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a9fcdb9c185416c25c3867e5529e77d0a"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d1/d36/namespacemom__offline__transport.html#a9fcdb9c185416c25c3867e5529e77d0a">distribute_residual_uh_barotropic</a> (G, GV, h, uh)</td></tr>
<tr class="memdesc:a9fcdb9c185416c25c3867e5529e77d0a"><td class="mdescLeft">&#160;</td><td class="mdescRight">In the case where offline advection has failed to converge, redistribute the u-flux into remainder of the water column as a barotropic equivalent.  <a href="#a9fcdb9c185416c25c3867e5529e77d0a">More...</a><br /></td></tr>
<tr class="separator:a9fcdb9c185416c25c3867e5529e77d0a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a4a0125de727abd3d5ca1691878b6efdd"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d1/d36/namespacemom__offline__transport.html#a4a0125de727abd3d5ca1691878b6efdd">distribute_residual_vh_barotropic</a> (G, GV, h, vh)</td></tr>
<tr class="memdesc:a4a0125de727abd3d5ca1691878b6efdd"><td class="mdescLeft">&#160;</td><td class="mdescRight">Redistribute the v-flux as a barotropic equivalent.  <a href="#a4a0125de727abd3d5ca1691878b6efdd">More...</a><br /></td></tr>
<tr class="separator:a4a0125de727abd3d5ca1691878b6efdd"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a7a78fb805fe7ed5fbf5d210ab3d6756e"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d1/d36/namespacemom__offline__transport.html#a7a78fb805fe7ed5fbf5d210ab3d6756e">distribute_residual_uh_upwards</a> (G, GV, h, uh)</td></tr>
<tr class="memdesc:a7a78fb805fe7ed5fbf5d210ab3d6756e"><td class="mdescLeft">&#160;</td><td class="mdescRight">In the case where offline advection has failed to converge, redistribute the u-flux into layers above.  <a href="#a7a78fb805fe7ed5fbf5d210ab3d6756e">More...</a><br /></td></tr>
<tr class="separator:a7a78fb805fe7ed5fbf5d210ab3d6756e"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a8c786211eb3fb4b841233094f5e5299b"><td class="memItemLeft" align="right" valign="top">subroutine, public&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d1/d36/namespacemom__offline__transport.html#a8c786211eb3fb4b841233094f5e5299b">distribute_residual_vh_upwards</a> (G, GV, h, vh)</td></tr>
<tr class="memdesc:a8c786211eb3fb4b841233094f5e5299b"><td class="mdescLeft">&#160;</td><td class="mdescRight">In the case where offline advection has failed to converge, redistribute the u-flux into layers above.  <a href="#a8c786211eb3fb4b841233094f5e5299b">More...</a><br /></td></tr>
<tr class="separator:a8c786211eb3fb4b841233094f5e5299b"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Contains routines related to offline transport of tracers. </p>
<h1><a class="anchor" id="offline_overview"></a>
Offline Tracer Transport in MOM6</h1>
<p>'Offline tracer modeling' uses physical fields (e.g. mass transports and layer thicknesses) saved from a previous integration of the physical model to transport passive tracers. These fields are accumulated or averaged over a period of time (in this test case, 1 day) and used to integrate portions of the MOM6 code base that handle the 3d advection and diffusion of passive tracers.</p>
<p>The distribution of tracers in the ocean modeled offline should not be expected to match an online simulation. Accumulating transports over more than one online model timestep implicitly assumes homogeneity over that time period and essentially aliases over processes that occur with higher frequency. For example, consider the case of a surface boundary layer with a strong diurnal cycle. An offline simulation with a 1 day timestep, captures the net transport into or out of that layer, but not the exact cycling. This effective aliasing may also complicate online model configurations which strongly-eddying regions. In this case, the offline model timestep must be limited to some fraction of the eddy correlation timescale. Lastly, the nonlinear advection scheme which applies limited mass-transports over a sequence of iterations means that tracers are not transported along exactly the same path as they are in the online model.</p>
<p>This capability has currently targeted the Baltic_ALE_z test case, though some work has also been done with the OM4 1/2 degree configuration. Work is ongoing to develop recommendations and best practices for investigators seeking to use MOM6 for offline tracer modeling.</p>
<h1><a class="anchor" id="offline_technical"></a>
Implementation of offline routine in MOM6</h1>
<p>The subroutine step_tracers that coordinates this can be found in <a class="el" href="../../d8/da7/MOM_8F90.html">MOM.F90</a> and is only called using the solo ocean driver. This is to avoid issues with coupling to other climate components that may be relying on fluxes from the ocean to be coupled more often than the offline time step. Other routines related to offline tracer modeling can be found in tracers/MOM_offline_control.F90</p>
<p>As can also be seen in the comments for the step_tracers subroutine, an offline time step comprises the following steps:</p><ol type="1">
<li>Using the layer thicknesses and tracer concentrations from the previous timestep, half of the accumulated vertical mixing (eatr and ebtr) is applied in the call to tracer_column_fns. For tracers whose source/sink terms need dt, this value is set to 1/2 dt_offline</li>
<li>Half of the accumulated surface freshwater fluxes are applied START ITERATION</li>
<li>Accumulated mass fluxes are used to do horizontal transport. The number of iterations used in advect_tracer is limited to 2 (e.g x-&gt;y-&gt;x-&gt;y). The remaining mass fluxes are stored for later use and resulting layer thicknesses fed into the next step</li>
<li>Tracers and the h-grid are regridded and remapped in a call to ALE. This allows for layers which might 'vanish' because of horizontal mass transport to be 'reinflated' and essentially allows for the vertical transport of tracers</li>
<li>Check that transport is done if the remaining mass fluxes equals 0 or if the max number of iterations has been reached END ITERATION</li>
<li>Repeat steps 1 and 2</li>
<li>Redistribute any residual mass fluxes that remain after the advection iterations in a barotropic manner, progressively upward through the water column.</li>
<li>Force a remapping to the stored layer thicknesses that correspond to the snapshot of the online model at the end of an accumulation interval</li>
<li>Reset T/S and h to their stored snapshotted values to prevent model drift</li>
</ol>
<h1><a class="anchor" id="offline_evaluation"></a>
Evaluating the utility of an offline tracer model</h1>
<p>How well an offline tracer model can be used as an alternative to integrating tracers online with the prognostic model must be evaluated for each application. This efficacy may be related to the native coordinate of the online model, to the length of the offline timestep, and to the behavior of the tracer itself.</p>
<p>A framework for formally regression testing the offline capability still needs to be developed. However, as a simple way of testing whether the offline model is nominally behaving as expected, the total inventory of the advection test tracers (tr1, tr2, etc.) should be conserved between time steps except for the last 4 decimal places. As a general guideline, an offline timestep of 5 days or less.</p>
<h1><a class="anchor" id="offline_parameters"></a>
Runtime parameters for offline tracers</h1>
<ul>
<li>OFFLINEDIR: Input directory where the offline fields can be found</li>
<li>OFF_SUM_FILE: Filename where the accumulated fields can be found (e.g. horizontal mass transports)</li>
<li>OFF_SNAP_FILE: Filename where snapshot fields can be found (e.g. end of timestep layer thickness)</li>
<li>START_INDEX: Which timelevel of the input files to read first</li>
<li>NUMTIME: How many timelevels to read before 'looping' back to 1</li>
<li>FIELDS_ARE_OFFSET: True if the time-averaged fields and snapshot fields are offset by one time level, probably not needed -NUM_OFF_ITER: Maximum number of iterations to do for the nonlinear advection scheme -REDISTRIBUTE_METHOD: Redistributes any remaining horizontal fluxes throughout the rest of water column. Options are 'barotropic' which "evenly distributes flux throughout the entire water column,'upwards' which adds the maximum of the remaining flux in each layer above, and 'none' which does no redistribution" </li>
</ul>
</div><h2 class="groupheader">Function/Subroutine Documentation</h2>
<a id="a9fcdb9c185416c25c3867e5529e77d0a"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a9fcdb9c185416c25c3867e5529e77d0a">&sect;&nbsp;</a></span>distribute_residual_uh_barotropic()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_offline_transport::distribute_residual_uh_barotropic </td>
          <td>(</td>
          <td class="paramtype">type(ocean_grid_type), pointer&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), pointer&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(g)), intent(inout)&#160;</td>
          <td class="paramname"><em>h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szib_(g),szj_(g),szk_(g)), intent(inout)&#160;</td>
          <td class="paramname"><em>uh</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>In the case where offline advection has failed to converge, redistribute the u-flux into remainder of the water column as a barotropic equivalent. </p>

<p>Definition at line <a class="el" href="../../de/df1/MOM__offline__control_8F90_source.html#l00518">518</a> of file <a class="el" href="../../de/df1/MOM__offline__control_8F90_source.html">MOM_offline_control.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;  <span class="keywordtype">type</span>(ocean_grid_type),    <span class="keywordtype">pointer</span>                           :: g</div><div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;  <span class="keywordtype">type</span>(verticalgrid_type),  <span class="keywordtype">pointer</span>                           :: gv</div><div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span>, <span class="keywordtype">intent(inout)</span>    :: h</div><div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZIB_(G),SZJ_(G),SZK_(G))</span>, <span class="keywordtype">intent(inout)</span>    :: uh</div><div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;</div><div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZIB_(G),SZK_(G))</span>   :: uh2d</div><div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZIB_(G))</span>           :: uh2d_sum</div><div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(G))</span>    :: h2d</div><div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G))</span>            :: h2d_sum</div><div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;</div><div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;  <span class="keywordtype">integer</span> :: i, j, k, m, is, ie, js, je, nz</div><div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;</div><div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;  <span class="comment">! Set index-related variables for fields on T-grid</span></div><div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;  is  = g%isc ; ie  = g%iec ; js  = g%jsc ; je  = g%jec ; nz = gv%ke</div><div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;</div><div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;  <span class="keywordflow">do</span> j=js,je</div><div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;    uh2d_sum(:) = 0.0</div><div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;    <span class="comment">! Copy over uh to a working array and sum up the remaining fluxes in a column</span></div><div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;    <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> i=is-1,ie</div><div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;      uh2d(i,k) = uh(i,j,k)</div><div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;      uh2d_sum(i) = uh2d_sum(i) + uh2d(i,k)</div><div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;</div><div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;    <span class="comment">! Copy over h to a working array and calculate column height</span></div><div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;    h2d_sum(:) = 0.0</div><div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;    <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> i=is-2,ie+1</div><div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;      h2d(i,k) = h(i,j,k)*g%areaT(i,j)</div><div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;      <span class="keywordflow">if</span>(h(i,j,k)&gt;gv%Angstrom) <span class="keywordflow">then</span></div><div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;        h2d_sum(i) = h2d_sum(i) + h2d(i,k)</div><div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;      <span class="keywordflow">else</span></div><div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;        h2d(i,k) = 0.0</div><div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;<span class="keyword">    end</span>do; enddo;</div><div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;</div><div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;</div><div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;    <span class="comment">! Distribute flux. Note min/max is intended to make sure that the mass transport</span></div><div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;    <span class="comment">! does not deplete a cell</span></div><div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;    <span class="keywordflow">do</span> i=is-1,ie</div><div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;      <span class="keywordflow">if</span>( uh2d_sum(i)&gt;0.0 ) <span class="keywordflow">then</span></div><div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;        <span class="keywordflow">do</span> k=1,nz</div><div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;          uh2d(i,k) = min(uh2d_sum(i)*(h2d(i,k)/h2d_sum(i)),h2d(i,k))</div><div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;<span class="keywordflow">        enddo</span></div><div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;      <span class="keywordflow">elseif</span> (uh2d_sum(i)&lt;0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;        <span class="keywordflow">do</span> k=1,nz</div><div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;          uh2d(i,k) = max(uh2d_sum(i)*(h2d(i+1,k)/h2d_sum(i+1)),-h2d(i+1,k))</div><div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;<span class="keywordflow">        enddo</span></div><div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;      <span class="keywordflow">else</span></div><div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;        <span class="keywordflow">do</span> k=1,nz</div><div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;          uh2d(i,k) = 0.0</div><div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;<span class="keywordflow">        enddo</span></div><div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;<span class="keywordflow">    enddo</span></div><div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;</div><div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;    <span class="comment">! Update layer thicknesses at the end </span></div><div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;    <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> i=is-2,ie+1</div><div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;      h(i,j,k) = h(i,j,k) + (uh2d(i-1,k) - uh2d(i,k))/g%areaT(i,j)</div><div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;    <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> i=is-1,ie</div><div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;      uh(i,j,k) = uh2d(i,k)</div><div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;      uh2d_sum(i) = uh2d_sum(i)-uh2d(i,k)</div><div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;<span class="keywordflow">  enddo</span></div><div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;</div></div><!-- fragment -->
</div>
</div>
<a id="a7a78fb805fe7ed5fbf5d210ab3d6756e"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a7a78fb805fe7ed5fbf5d210ab3d6756e">&sect;&nbsp;</a></span>distribute_residual_uh_upwards()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_offline_transport::distribute_residual_uh_upwards </td>
          <td>(</td>
          <td class="paramtype">type(ocean_grid_type), pointer&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), pointer&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(g)), intent(inout)&#160;</td>
          <td class="paramname"><em>h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szib_(g),szj_(g),szk_(g)), intent(inout)&#160;</td>
          <td class="paramname"><em>uh</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>In the case where offline advection has failed to converge, redistribute the u-flux into layers above. </p>

<p>Definition at line <a class="el" href="../../de/df1/MOM__offline__control_8F90_source.html#l00653">653</a> of file <a class="el" href="../../de/df1/MOM__offline__control_8F90_source.html">MOM_offline_control.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;  <span class="keywordtype">type</span>(ocean_grid_type),    <span class="keywordtype">pointer</span>                           :: g</div><div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;  <span class="keywordtype">type</span>(verticalgrid_type),  <span class="keywordtype">pointer</span>                           :: gv</div><div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span>, <span class="keywordtype">intent(inout)</span>     :: h</div><div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZIB_(G),SZJ_(G),SZK_(G))</span>, <span class="keywordtype">intent(inout)</span>    :: uh</div><div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;</div><div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZIB_(G),SZK_(G))</span>   :: uh2d</div><div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZK_(G))</span>    :: h2d</div><div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;  <span class="keywordtype">logical</span>, <span class="keywordtype">dimension(SZK_(G))</span>            :: filled</div><div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;</div><div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;  <span class="keywordtype">real</span>  :: uh_neglect, uh_remain, uh_lb, uh_ub, uh_add, uh_max, uh_sum</div><div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;  <span class="keywordtype">real</span>  :: hup, hdown, hlos, min_h</div><div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;  <span class="keywordtype">integer</span> :: i, j, k, m, is, ie, js, je, nz, k_rev</div><div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;</div><div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;  <span class="comment">! Set index-related variables for fields on T-grid</span></div><div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;  is  = g%isc ; ie  = g%iec ; js  = g%jsc ; je  = g%jec ; nz = gv%ke</div><div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;</div><div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;  min_h = 0.1*gv%Angstrom</div><div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;</div><div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;  <span class="keywordflow">do</span> j=js,je</div><div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;    <span class="comment">! Copy over uh and cell volume to working arrays</span></div><div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;    <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> i=is-1,ie</div><div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;      uh2d(i,k) = uh(i,j,k)</div><div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;    <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> i=is-2,ie+1</div><div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;      <span class="comment">! Subtract just a little bit of thickness to avoid roundoff errors</span></div><div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;      h2d(i,k) = max(h(i,j,k)*g%areaT(i,j)-min_h*g%areaT(i,j),min_h*g%areaT(i,j))</div><div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;</div><div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;    <span class="keywordflow">do</span> i=is-1,ie </div><div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;      uh_sum = sum(uh2d(i,:))</div><div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;      <span class="keywordflow">do</span> k=1,nz</div><div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;        uh_remain = uh2d(i,k) </div><div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;        uh_neglect = gv%H_subroundoff*min(g%areaT(i,j),g%areaT(i+1,j))</div><div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;</div><div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;        <span class="keywordflow">if</span>(uh_remain&lt;-uh_neglect) <span class="keywordflow">then</span></div><div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;          <span class="comment">! Set the mass flux to zero. This will be refilled in the first iteration </span></div><div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;          uh2d(i,k) = 0.0</div><div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;</div><div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;          <span class="keywordflow">do</span> k_rev=k,1,-1</div><div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;            <span class="comment">! Calculate the lower bound of uh(I)</span></div><div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;            hlos = max(uh2d(i+1,k_rev),0.0)</div><div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;            <span class="comment">! This lower bound is deliberately conservative to ensure that nothing will be left after </span></div><div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;            uh_lb = min(-0.5*h2d(i+1,k_rev), -0.5*hlos, 0.0)</div><div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;              <span class="comment">! Calculate the maximum amount that could be added</span></div><div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;              uh_max = uh_lb-uh2d(i,k_rev)</div><div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;              <span class="comment">! Calculate how much will actually be added to uh(I)</span></div><div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;              uh_add = max(uh_max,uh_remain)</div><div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;              <span class="comment">! Reduce the remaining flux </span></div><div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;              uh_remain = uh_remain - uh_add</div><div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;              uh2d(i,k_rev) = uh2d(i,k_rev) + uh_add</div><div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;              <span class="keywordflow">if</span>(uh2d(i,k_rev)==uh_lb) filled(k_rev)=.true.</div><div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160;              <span class="keywordflow">if</span>(uh_remain&gt;-uh_neglect) <span class="keywordflow">exit</span></div><div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;<span class="keywordflow">          enddo</span></div><div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;</div><div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160;        <span class="keywordflow">elseif</span> (uh_remain&gt;uh_neglect) <span class="keywordflow">then</span></div><div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160;          <span class="comment">! Set the amount in the layer with remaining fluxes to zero. This will be reset </span></div><div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160;          <span class="comment">! in the first iteration of the redistribution loop</span></div><div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160;          uh2d(i,k) = 0.0</div><div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;          <span class="comment">! Loop to distribute remaining flux in layers above</span></div><div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;          <span class="keywordflow">do</span> k_rev=k,1,-1</div><div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;            hlos = max(0.0,-uh2d(i-1,k_rev))</div><div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160;            <span class="comment">! Calculate the upper bound of uh(I)</span></div><div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;            uh_ub = max(0.5*h2d(i,k_rev), 0.5*h2d(i,k_rev)-hlos, 0.0)</div><div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;            <span class="comment">! Calculate the maximum amount that could be added</span></div><div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;            uh_max = uh_ub-uh2d(i,k_rev)</div><div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;            <span class="comment">! Calculate how much will actually be added to uh(I)</span></div><div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;            uh_add = min(uh_max,uh_remain)</div><div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;            <span class="comment">! Reduce the remaining flux </span></div><div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;            uh_remain = uh_remain - uh_add</div><div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;            uh2d(i,k_rev) = uh2d(i,k_rev) + uh_add</div><div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160;            <span class="keywordflow">if</span>(uh_remain&lt;uh_neglect) <span class="keywordflow">exit</span></div><div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160;<span class="keywordflow">          enddo</span></div><div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;          <span class="comment">! Check to see if there&#39;s any mass flux left. If so, put it in the layer beneath, unless we&#39;ve bottomed out</span></div><div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;        <span class="keywordflow">if</span>(abs(uh_remain)&gt;uh_neglect) <span class="keywordflow">then</span></div><div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;          <span class="keywordflow">if</span>(k&lt;nz) <span class="keywordflow">then</span></div><div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;            uh2d(i,k+1) = uh2d(i,k+1) + uh_remain</div><div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;          <span class="keywordflow">else</span></div><div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;            <span class="keyword">call </span>mom_error(warning,<span class="stringliteral">&quot;Water column cannot accommodate UH redistribution. Tracer will not be conserved&quot;</span>)</div><div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;<span class="keywordflow">          endif</span></div><div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;</div><div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;<span class="keywordflow">      enddo</span></div><div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;</div><div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160;<span class="keywordflow">    enddo</span></div><div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;</div><div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;    <span class="comment">! Update layer thicknesses at the end </span></div><div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;    <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;      h(i,j,k) = (h(i,j,k)*g%areaT(i,j) + (uh2d(i-1,k) - uh2d(i,k)))/g%areaT(i,j)</div><div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160;    <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> i=is-1,ie</div><div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160;      uh(i,j,k) = uh2d(i,k)</div><div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;<span class="keywordflow">  enddo</span></div><div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;</div></div><!-- fragment -->
</div>
</div>
<a id="a4a0125de727abd3d5ca1691878b6efdd"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a4a0125de727abd3d5ca1691878b6efdd">&sect;&nbsp;</a></span>distribute_residual_vh_barotropic()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_offline_transport::distribute_residual_vh_barotropic </td>
          <td>(</td>
          <td class="paramtype">type(ocean_grid_type), pointer&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), pointer&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(g)), intent(inout)&#160;</td>
          <td class="paramname"><em>h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szjb_(g),szk_(g)), intent(inout)&#160;</td>
          <td class="paramname"><em>vh</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Redistribute the v-flux as a barotropic equivalent. </p>

<p>Definition at line <a class="el" href="../../de/df1/MOM__offline__control_8F90_source.html#l00585">585</a> of file <a class="el" href="../../de/df1/MOM__offline__control_8F90_source.html">MOM_offline_control.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;  <span class="keywordtype">type</span>(ocean_grid_type),    <span class="keywordtype">pointer</span>                           :: g</div><div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;  <span class="keywordtype">type</span>(verticalgrid_type),  <span class="keywordtype">pointer</span>                           :: gv</div><div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span>, <span class="keywordtype">intent(inout)</span>    :: h</div><div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJB_(G),SZK_(G))</span>, <span class="keywordtype">intent(inout)</span>    :: vh</div><div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;</div><div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZJB_(G),SZK_(G))</span>   :: vh2d</div><div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZJB_(G))</span>           :: vh2d_sum</div><div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZJ_(G),SZK_(G))</span>    :: h2d</div><div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZJ_(G))</span>            :: h2d_sum</div><div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;</div><div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;  <span class="keywordtype">integer</span> :: i, j, k, m, is, ie, js, je, nz</div><div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;</div><div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;  <span class="comment">! Set index-related variables for fields on T-grid</span></div><div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;  is  = g%isc ; ie  = g%iec ; js  = g%jsc ; je  = g%jec ; nz = gv%ke</div><div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;</div><div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;  <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;    vh2d_sum(:) = 0.0</div><div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;    <span class="comment">! Copy over uh to a working array and sum up the remaining fluxes in a column</span></div><div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;    <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> j=js-1,je</div><div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;      vh2d(j,k) = vh(i,j,k)</div><div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;      vh2d_sum(j) = vh2d_sum(j) + vh2d(j,k)</div><div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;</div><div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;    <span class="comment">! Copy over h to a working array and calculate column volume</span></div><div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;    h2d_sum(:) = 0.0</div><div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;    <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> j=js-2,je+1</div><div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;      h2d(j,k) = h(i,j,k)*g%areaT(i,j)</div><div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;      <span class="keywordflow">if</span>(h(i,j,k)&gt;gv%Angstrom) <span class="keywordflow">then</span></div><div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;        h2d_sum(j) = h2d_sum(j) + h2d(j,k)</div><div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;      <span class="keywordflow">else</span></div><div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;        h2d(j,k) = 0.0</div><div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;<span class="keyword">    end</span>do; enddo;</div><div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;</div><div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;</div><div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;    <span class="comment">! Distribute flux. Note min/max is intended to make sure that the mass transport</span></div><div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;    <span class="comment">! does not deplete a cell</span></div><div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;    <span class="keywordflow">do</span> j=js-1,je</div><div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;      <span class="keywordflow">if</span>( vh2d_sum(j)&gt;0.0 ) <span class="keywordflow">then</span></div><div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;        <span class="keywordflow">do</span> k=1,nz</div><div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;          vh2d(j,k) = min(vh2d_sum(j)*(h2d(j,k)/h2d_sum(j)),0.5*h2d(j,k))</div><div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;<span class="keywordflow">        enddo</span></div><div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;      <span class="keywordflow">elseif</span> (vh2d_sum(j)&lt;0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;        <span class="keywordflow">do</span> k=1,nz</div><div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;          vh2d(j,k) = max(vh2d_sum(j)*(h2d(j+1,k)/h2d_sum(j+1)),-0.5*h2d(j+1,k))</div><div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;<span class="keywordflow">        enddo</span></div><div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;      <span class="keywordflow">else</span></div><div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;        <span class="keywordflow">do</span> k=1,nz</div><div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;          vh2d(j,k) = 0.0</div><div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;<span class="keywordflow">        enddo</span></div><div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;<span class="keywordflow">    enddo</span></div><div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;</div><div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;</div><div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;    <span class="comment">! Update layer thicknesses at the end </span></div><div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;    <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> j=js-2,je+1</div><div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;      h(i,j,k) = h(i,j,k) + (vh2d(j-1,k) - vh2d(j,k))/g%areaT(i,j)</div><div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;    <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> j=js-1,je</div><div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;      vh(i,j,k) = vh2d(j,k)</div><div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;<span class="keywordflow">  enddo</span></div><div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;</div></div><!-- fragment -->
</div>
</div>
<a id="a8c786211eb3fb4b841233094f5e5299b"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a8c786211eb3fb4b841233094f5e5299b">&sect;&nbsp;</a></span>distribute_residual_vh_upwards()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_offline_transport::distribute_residual_vh_upwards </td>
          <td>(</td>
          <td class="paramtype">type(ocean_grid_type), pointer&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), pointer&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(g)), intent(inout)&#160;</td>
          <td class="paramname"><em>h</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szjb_(g),szk_(g)), intent(inout)&#160;</td>
          <td class="paramname"><em>vh</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>In the case where offline advection has failed to converge, redistribute the u-flux into layers above. </p>

<p>Definition at line <a class="el" href="../../de/df1/MOM__offline__control_8F90_source.html#l00753">753</a> of file <a class="el" href="../../de/df1/MOM__offline__control_8F90_source.html">MOM_offline_control.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;  <span class="keywordtype">type</span>(ocean_grid_type),    <span class="keywordtype">pointer</span>                          :: g</div><div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;  <span class="keywordtype">type</span>(verticalgrid_type),  <span class="keywordtype">pointer</span>                          :: gv</div><div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span>,  <span class="keywordtype">intent(inout)</span>   :: h</div><div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJB_(G),SZK_(G))</span>, <span class="keywordtype">intent(inout)</span>   :: vh</div><div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;</div><div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZJB_(G),SZK_(G))</span>   :: vh2d</div><div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZJB_(G))</span>           :: vh2d_sum</div><div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZJ_(G),SZK_(G))</span>    :: h2d</div><div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZJ_(G))</span>            :: h2d_sum</div><div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160;</div><div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;  <span class="keywordtype">real</span>  :: vh_neglect, vh_remain, vh_max, vh_add, vh_ub, vh_lb, vh_sum</div><div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;  <span class="keywordtype">real</span>  :: hup, hlos, min_h</div><div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160;  <span class="keywordtype">integer</span> :: i, j, k, m, is, ie, js, je, nz, k_rev</div><div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160;</div><div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160;  <span class="comment">! Set index-related variables for fields on T-grid</span></div><div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160;  is  = g%isc ; ie  = g%iec ; js  = g%jsc ; je  = g%jec ; nz = gv%ke</div><div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160;</div><div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160;  min_h = 0.1*gv%Angstrom</div><div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160;</div><div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;  <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160;    <span class="comment">! Copy over uh and cell volume to working arrays</span></div><div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160;    <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> j=js-1,je</div><div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160;      vh2d(j,k) = vh(i,j,k)</div><div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160;    <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> j=js-2,je+1</div><div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160;      h2d(j,k) = (h(i,j,k)-min_h)*g%areaT(i,j)</div><div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160;</div><div class="line"><a name="l00781"></a><span class="lineno">  781</span>&#160;    <span class="keywordflow">do</span> j=js,je</div><div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160;      vh_sum=sum(vh2d(j,:))</div><div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160;      <span class="keywordflow">do</span> k=1,nz</div><div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160;        vh_remain = vh2d(j,k) </div><div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160;        vh_neglect = gv%H_subroundoff*min(g%areaT(i,j),g%areaT(i,j+1))</div><div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160;        <span class="keywordflow">if</span>(vh_remain&lt;0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160;          <span class="comment">! Set the amount in the layer with remaining fluxes to zero. This will be reset </span></div><div class="line"><a name="l00788"></a><span class="lineno">  788</span>&#160;          <span class="comment">! in the first iteration of the redistribution loop</span></div><div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160;          vh2d(j,k) = 0.0</div><div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;          <span class="keywordflow">do</span> k_rev=k,1,-1</div><div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160;            <span class="comment">! Calculate the lower bound of uh(I)</span></div><div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160;            hlos = max(vh2d(j+1,k_rev),0.0)</div><div class="line"><a name="l00793"></a><span class="lineno">  793</span>&#160;            vh_lb = min(-0.5*h2d(j+1,k_rev), -0.5*h2d(j+1,k_rev)+hlos, 0.0)</div><div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160;            <span class="comment">! Calculate the maximum amount that could be added</span></div><div class="line"><a name="l00795"></a><span class="lineno">  795</span>&#160;            vh_max = vh_lb-vh2d(j,k_rev)</div><div class="line"><a name="l00796"></a><span class="lineno">  796</span>&#160;            <span class="comment">! Calculate how much will actually be added to uh(I)</span></div><div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160;            vh_add = max(vh_max,vh_remain)</div><div class="line"><a name="l00798"></a><span class="lineno">  798</span>&#160;            <span class="comment">! Reduce the remaining flux </span></div><div class="line"><a name="l00799"></a><span class="lineno">  799</span>&#160;            vh_remain = vh_remain - vh_add</div><div class="line"><a name="l00800"></a><span class="lineno">  800</span>&#160;            vh2d(j,k_rev) = vh2d(j,k_rev) + vh_add</div><div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160;            <span class="keywordflow">if</span>(vh_remain&gt;-vh_neglect) <span class="keywordflow">exit</span></div><div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;</div><div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160;<span class="keywordflow">          enddo</span></div><div class="line"><a name="l00804"></a><span class="lineno">  804</span>&#160;        <span class="keywordflow">elseif</span> (vh_remain&gt;0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;          <span class="comment">! Set the amount in the layer with remaining fluxes to zero. This will be reset </span></div><div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160;          <span class="comment">! in the first iteration of the redistribution loop</span></div><div class="line"><a name="l00807"></a><span class="lineno">  807</span>&#160;          vh2d(j,k) = 0</div><div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160;          <span class="comment">! Loop to distribute remaining flux in layers above</span></div><div class="line"><a name="l00809"></a><span class="lineno">  809</span>&#160;          <span class="keywordflow">do</span> k_rev=k,1,-1</div><div class="line"><a name="l00810"></a><span class="lineno">  810</span>&#160;            hlos = max(-vh2d(j-1,k_rev),0.0)</div><div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160;            <span class="comment">! Calculate the upper bound of uh(I)</span></div><div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160;            vh_ub = max(0.5*h2d(j,k_rev), 0.5*h2d(j,k_rev)-hlos, 0.0)</div><div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160;            <span class="comment">! Calculate the maximum amount that could be added</span></div><div class="line"><a name="l00814"></a><span class="lineno">  814</span>&#160;            vh_max = vh_ub-vh2d(j,k_rev)</div><div class="line"><a name="l00815"></a><span class="lineno">  815</span>&#160;            <span class="comment">! Calculate how much will actually be added to uh(I)</span></div><div class="line"><a name="l00816"></a><span class="lineno">  816</span>&#160;            vh_add = min(vh_max,vh_remain)</div><div class="line"><a name="l00817"></a><span class="lineno">  817</span>&#160;            <span class="comment">! Reduce the remaining flux </span></div><div class="line"><a name="l00818"></a><span class="lineno">  818</span>&#160;            vh_remain = vh_remain - vh_add</div><div class="line"><a name="l00819"></a><span class="lineno">  819</span>&#160;            vh2d(j,k_rev) = vh2d(j,k_rev) + vh_add</div><div class="line"><a name="l00820"></a><span class="lineno">  820</span>&#160;            <span class="keywordflow">if</span>(vh_remain&lt;vh_neglect) <span class="keywordflow">exit</span></div><div class="line"><a name="l00821"></a><span class="lineno">  821</span>&#160;<span class="keywordflow">          enddo</span></div><div class="line"><a name="l00822"></a><span class="lineno">  822</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00823"></a><span class="lineno">  823</span>&#160;        <span class="keywordflow">if</span>(abs(vh_remain)&gt;vh_neglect) <span class="keywordflow">then</span></div><div class="line"><a name="l00824"></a><span class="lineno">  824</span>&#160;          <span class="keywordflow">if</span>(k&lt;nz) <span class="keywordflow">then</span></div><div class="line"><a name="l00825"></a><span class="lineno">  825</span>&#160;            vh2d(j,k+1) = vh2d(j,k+1) + vh_remain</div><div class="line"><a name="l00826"></a><span class="lineno">  826</span>&#160;          <span class="keywordflow">else</span></div><div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160;            <span class="keyword">call </span>mom_error(warning,<span class="stringliteral">&quot;Water column cannot accommodate UH redistribution. Tracer will not be conserved&quot;</span>)</div><div class="line"><a name="l00828"></a><span class="lineno">  828</span>&#160;<span class="keywordflow">          endif</span></div><div class="line"><a name="l00829"></a><span class="lineno">  829</span>&#160;<span class="keywordflow">        endif</span></div><div class="line"><a name="l00830"></a><span class="lineno">  830</span>&#160;<span class="keywordflow">      enddo</span> </div><div class="line"><a name="l00831"></a><span class="lineno">  831</span>&#160;</div><div class="line"><a name="l00832"></a><span class="lineno">  832</span>&#160;<span class="keywordflow">    enddo</span></div><div class="line"><a name="l00833"></a><span class="lineno">  833</span>&#160;</div><div class="line"><a name="l00834"></a><span class="lineno">  834</span>&#160;    <span class="comment">! Update layer thicknesses at the end </span></div><div class="line"><a name="l00835"></a><span class="lineno">  835</span>&#160;    <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> j=js,je</div><div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160;      h(i,j,k) = (h(i,j,k)*g%areaT(i,j) + (vh2d(j-1,k) - vh2d(j,k)))/g%areaT(i,j)</div><div class="line"><a name="l00837"></a><span class="lineno">  837</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00838"></a><span class="lineno">  838</span>&#160;    <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> j=js-1,je</div><div class="line"><a name="l00839"></a><span class="lineno">  839</span>&#160;      vh(i,j,k) = vh2d(j,k)</div><div class="line"><a name="l00840"></a><span class="lineno">  840</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00841"></a><span class="lineno">  841</span>&#160;<span class="keywordflow">  enddo</span></div><div class="line"><a name="l00842"></a><span class="lineno">  842</span>&#160;</div></div><!-- fragment -->
</div>
</div>
<a id="a2a5e42b28ad3cc833ecb0b65de75e454"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a2a5e42b28ad3cc833ecb0b65de75e454">&sect;&nbsp;</a></span>limit_mass_flux_3d()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_offline_transport::limit_mass_flux_3d </td>
          <td>(</td>
          <td class="paramtype">type(ocean_grid_type), pointer&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), pointer&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szib_(g),szj_(g),szk_(g)), intent(inout)&#160;</td>
          <td class="paramname"><em>uh</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szjb_(g),szk_(g)), intent(inout)&#160;</td>
          <td class="paramname"><em>vh</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(g)), intent(inout)&#160;</td>
          <td class="paramname"><em>ea</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(g)), intent(inout)&#160;</td>
          <td class="paramname"><em>eb</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(g)), intent(in)&#160;</td>
          <td class="paramname"><em>h_pre</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, intent(in)&#160;</td>
          <td class="paramname"><em>max_off_cfl</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>This routine limits the mass fluxes so that the a layer cannot be completely depleted. NOTE: Only used in non-ALE mode. </p>

<p>Definition at line <a class="el" href="../../de/df1/MOM__offline__control_8F90_source.html#l00423">423</a> of file <a class="el" href="../../de/df1/MOM__offline__control_8F90_source.html">MOM_offline_control.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;  <span class="keywordtype">type</span>(ocean_grid_type),    <span class="keywordtype">pointer</span>                           :: g</div><div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;  <span class="keywordtype">type</span>(verticalgrid_type),  <span class="keywordtype">pointer</span>                           :: gv</div><div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZIB_(G),SZJ_(G),SZK_(G))</span>, <span class="keywordtype">intent(inout)</span>    :: uh</div><div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJB_(G),SZK_(G))</span>, <span class="keywordtype">intent(inout)</span>    :: vh</div><div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span> , <span class="keywordtype">intent(inout)</span>    :: ea</div><div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span> , <span class="keywordtype">intent(inout)</span>    :: eb</div><div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span> , <span class="keywordtype">intent(in)</span>       :: h_pre</div><div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;  <span class="keywordtype">real</span>,                                      <span class="keywordtype">intent(in)</span>       :: max_off_cfl</div><div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;</div><div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;  <span class="comment">! Local variables</span></div><div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;  <span class="keywordtype">integer</span> :: i, j, k, m, is, ie, js, je, nz</div><div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span>                    :: top_flux, bottom_flux</div><div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;  <span class="keywordtype">real</span>                                                        :: pos_flux, hvol, h_neglect, scale_factor</div><div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;</div><div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;</div><div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;  <span class="comment">! In this subroutine, fluxes out of the box are scaled away if they deplete</span></div><div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;  <span class="comment">! the layer, note that we define the positive direction as flux out of the box.</span></div><div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;  <span class="comment">! Hence, uh(I-1) is multipled by negative one, but uh(I) is not</span></div><div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;</div><div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;  <span class="comment">! Set index-related variables for fields on T-grid</span></div><div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;  is  = g%isc ; ie  = g%iec ; js  = g%jsc ; je  = g%jec ; nz = gv%ke</div><div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;</div><div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;  <span class="comment">! Calculate top and bottom fluxes from ea and eb. Note the explicit negative signs</span></div><div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;  <span class="comment">! to enforce the positive out convention</span></div><div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;  k = 1</div><div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;  <span class="keywordflow">do</span> j=js-1,je+1 ; <span class="keywordflow">do</span> i=is-1,ie+1</div><div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;    top_flux(i,j,k) = -ea(i,j,k)</div><div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;    bottom_flux(i,j,k) = -(eb(i,j,k)-ea(i,j,k+1))</div><div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;<span class="keywordflow">  enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;</div><div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;  <span class="keywordflow">do</span> k=2, nz-1 ; <span class="keywordflow">do</span> j=js-1,je+1 ; <span class="keywordflow">do</span> i=is-1,ie+1</div><div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;    top_flux(i,j,k) = -(ea(i,j,k)-eb(i,j,k-1))</div><div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;    bottom_flux(i,j,k) = -(eb(i,j,k)-ea(i,j,k+1))</div><div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;<span class="keywordflow">  enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;</div><div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;  k=nz</div><div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;  <span class="keywordflow">do</span> j=js-1,je+1 ; <span class="keywordflow">do</span> i=is-1,ie+1</div><div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;    top_flux(i,j,k) = -(ea(i,j,k)-eb(i,j,k-1))</div><div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;    bottom_flux(i,j,k) = -eb(i,j,k)</div><div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;<span class="keywordflow">  enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;</div><div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;</div><div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;  <span class="comment">! Calculate sum of positive fluxes (negatives applied to enforce convention)</span></div><div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;  <span class="comment">! in a given cell and scale it back if it would deplete a layer</span></div><div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;  <span class="keywordflow">do</span> k = 1, nz ; <span class="keywordflow">do</span> j=js-1,je+1 ; <span class="keywordflow">do</span> i=is-1,ie+1</div><div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;</div><div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;    hvol = h_pre(i,j,k)*g%areaT(i,j)</div><div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;    pos_flux  = max(0.0,-uh(i-1,j,k)) + max(0.0, -vh(i,j-1,k)) + &amp;</div><div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;      max(0.0, uh(i,j,k)) + max(0.0, vh(i,j,k)) + &amp;</div><div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;      max(0.0, top_flux(i,j,k)*g%areaT(i,j)) + max(0.0, bottom_flux(i,j,k)*g%areaT(i,j))</div><div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;</div><div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;    <span class="keywordflow">if</span> (pos_flux&gt;hvol .and. pos_flux&gt;0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;      scale_factor = ( hvol )/pos_flux*max_off_cfl</div><div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;    <span class="keywordflow">else</span> <span class="comment">! Don&#39;t scale</span></div><div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;      scale_factor = 1.0</div><div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;</div><div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;    <span class="comment">! Scale horizontal fluxes</span></div><div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;    <span class="keywordflow">if</span> (-uh(i-1,j,k)&gt;0) uh(i-1,j,k) = uh(i-1,j,k)*scale_factor</div><div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;    <span class="keywordflow">if</span> (uh(i,j,k)&gt;0)    uh(i,j,k)   = uh(i,j,k)*scale_factor</div><div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;    <span class="keywordflow">if</span> (-vh(i,j-1,k)&gt;0) vh(i,j-1,k) = vh(i,j-1,k)*scale_factor</div><div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;    <span class="keywordflow">if</span> (vh(i,j,k)&gt;0)    vh(i,j,k)   = vh(i,j,k)*scale_factor</div><div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;</div><div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;    <span class="keywordflow">if</span> (k&gt;1 .and. k&lt;nz) <span class="keywordflow">then</span></div><div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;    <span class="comment">! Scale interior layers</span></div><div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;      <span class="keywordflow">if</span>(top_flux(i,j,k)&gt;0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;        ea(i,j,k) = ea(i,j,k)*scale_factor</div><div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;        eb(i,j,k-1) = eb(i,j,k-1)*scale_factor</div><div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;      <span class="keywordflow">if</span>(bottom_flux(i,j,k)&gt;0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;        eb(i,j,k) = eb(i,j,k)*scale_factor</div><div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;        ea(i,j,k+1) = ea(i,j,k+1)*scale_factor</div><div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;    <span class="comment">! Scale top layer</span></div><div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;    <span class="keywordflow">elseif</span> (k==1) <span class="keywordflow">then</span></div><div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;      <span class="keywordflow">if</span>(top_flux(i,j,k)&gt;0.0)    ea(i,j,k) = ea(i,j,k)*scale_factor</div><div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;      <span class="keywordflow">if</span>(bottom_flux(i,j,k)&gt;0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;        eb(i,j,k)   = eb(i,j,k)*scale_factor</div><div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;        ea(i,j,k+1) = ea(i,j,k+1)*scale_factor</div><div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;    <span class="comment">! Scale bottom layer</span></div><div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;    <span class="keywordflow">elseif</span> (k==nz) <span class="keywordflow">then</span></div><div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;      <span class="keywordflow">if</span>(top_flux(i,j,k)&gt;0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;        ea(i,j,k)   = ea(i,j,k)*scale_factor</div><div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;        eb(i,j,k-1) = eb(i,j,k-1)*scale_factor</div><div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;<span class="keywordflow">      endif</span></div><div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;      <span class="keywordflow">if</span> (bottom_flux(i,j,k)&gt;0.0) eb(i,j,k)=eb(i,j,k)*scale_factor</div><div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;<span class="keywordflow">  enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;</div></div><!-- fragment -->
</div>
</div>
<a id="a277e868a412054fa0cf723b15e32b8a2"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a277e868a412054fa0cf723b15e32b8a2">&sect;&nbsp;</a></span>next_modulo_time()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">integer function mom_offline_transport::next_modulo_time </td>
          <td>(</td>
          <td class="paramtype">integer&#160;</td>
          <td class="paramname"><em>inidx</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer&#160;</td>
          <td class="paramname"><em>numtime</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Calculates the next timelevel to read from the input fields. This allows the 'looping' of the fields. </p>

<p>Definition at line <a class="el" href="../../de/df1/MOM__offline__control_8F90_source.html#l00323">323</a> of file <a class="el" href="../../de/df1/MOM__offline__control_8F90_source.html">MOM_offline_control.F90</a>.</p>

<p>Referenced by <a class="el" href="../../de/df1/MOM__offline__control_8F90_source.html#l00248">offline_transport_init()</a>, and <a class="el" href="../../de/df1/MOM__offline__control_8F90_source.html#l00083">transport_by_files()</a>.</p>
<div class="fragment"><div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;  <span class="comment">! Returns the next time interval to be read</span></div><div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;  <span class="keywordtype">integer</span>                 :: numtime              <span class="comment">! Number of time levels in input fields</span></div><div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;  <span class="keywordtype">integer</span>                 :: inidx                <span class="comment">! The current time index</span></div><div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;</div><div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;  <span class="keywordtype">integer</span>                 :: read_index           <span class="comment">! The index in the input files that corresponds</span></div><div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;                                                  <span class="comment">! to the current timestep</span></div><div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;</div><div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;  <span class="keywordtype">integer</span>                 :: next_modulo_time</div><div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;</div><div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;  read_index = mod(inidx+1,numtime)</div><div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;  <span class="keywordflow">if</span> (read_index &lt; 0)  read_index = inidx-read_index</div><div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;  <span class="keywordflow">if</span> (read_index == 0) read_index = numtime</div><div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;</div><div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;  next_modulo_time = read_index</div><div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;</div></div><!-- fragment --><div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="../../d1/d36/namespacemom__offline__transport_a277e868a412054fa0cf723b15e32b8a2_icgraph.svg" width="360" height="118"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>

</div>
</div>
<a id="a44091358f321c2eeb97e5542d2176446"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a44091358f321c2eeb97e5542d2176446">&sect;&nbsp;</a></span>offline_transport_init()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_offline_transport::offline_transport_init </td>
          <td>(</td>
          <td class="paramtype">type(param_file_type), intent(in)&#160;</td>
          <td class="paramname"><em>param_file</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="../../d0/d2c/structmom__offline__transport_1_1offline__transport__cs.html">offline_transport_cs</a>), intent(inout), pointer&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(diabatic_aux_cs), intent(in), pointer&#160;</td>
          <td class="paramname"><em>diabatic_aux_CSp</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(ocean_grid_type), intent(in)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(in)&#160;</td>
          <td class="paramname"><em>GV</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Initializes the control structure for offline transport and reads in some of the. </p>

<p>Definition at line <a class="el" href="../../de/df1/MOM__offline__control_8F90_source.html#l00248">248</a> of file <a class="el" href="../../de/df1/MOM__offline__control_8F90_source.html">MOM_offline_control.F90</a>.</p>

<p>References <a class="el" href="../../de/df1/MOM__offline__control_8F90_source.html#l00323">next_modulo_time()</a>.</p>
<div class="fragment"><div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;</div><div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;  <span class="keywordtype">type</span>(param_file_type),               <span class="keywordtype">intent(in)</span>     :: param_file</div><div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;  <span class="keywordtype">type</span>(offline_transport_cs), <span class="keywordtype">pointer</span>, <span class="keywordtype">intent(inout)</span>  :: cs</div><div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;  <span class="keywordtype">type</span>(diabatic_aux_cs),          <span class="keywordtype">pointer</span>, <span class="keywordtype">intent(in)</span> :: diabatic_aux_csp</div><div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;  <span class="keywordtype">type</span>(ocean_grid_type),               <span class="keywordtype">intent(in)</span>     :: g</div><div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;  <span class="keywordtype">type</span>(verticalgrid_type),             <span class="keywordtype">intent(in)</span>     :: gv</div><div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;</div><div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;  <span class="keywordtype">character(len=40)</span>                               :: mod = <span class="stringliteral">&quot;offline_transport&quot;</span></div><div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;</div><div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;  <span class="keywordtype">integer</span> :: i, j, k, is, ie, js, je, isd, ied, jsd, jed, nz</div><div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;  <span class="keywordtype">integer</span> :: isdb, iedb, jsdb, jedb</div><div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;</div><div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;  is   = g%isc   ; ie   = g%iec  ; js   = g%jsc  ; je   = g%jec ; nz = gv%ke</div><div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;  isd  = g%isd   ; ied  = g%ied  ; jsd  = g%jsd  ; jed  = g%jed</div><div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;  isdb = g%IsdB  ; iedb = g%IedB ; jsdb = g%JsdB ; jedb = g%JedB</div><div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;</div><div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;  <span class="keyword">call </span>calltree_enter(<span class="stringliteral">&quot;offline_transport_init, MOM_offline_control.F90&quot;</span>)</div><div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;</div><div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(cs)) <span class="keywordflow">then</span></div><div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;    <span class="keyword">call </span>mom_error(warning, <span class="stringliteral">&quot;offline_transport_init called with an associated &quot;</span>// &amp;</div><div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;      <span class="stringliteral">&quot;control structure.&quot;</span>)</div><div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;    <span class="keywordflow">return</span></div><div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;  <span class="keyword">allocate</span>(cs)</div><div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;  <span class="keyword">call </span>log_version(param_file,mod,version, &amp;</div><div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;    <span class="stringliteral">&quot;This module allows for tracers to be run offline&quot;</span>)</div><div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;</div><div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;  <span class="comment">! Parse MOM_input for offline control</span></div><div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;  <span class="keyword">call </span>get_param(param_file, mod, <span class="stringliteral">&quot;OFFLINEDIR&quot;</span>, cs%offlinedir, &amp;</div><div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;    <span class="stringliteral">&quot;Input directory where the offline fields can be found&quot;</span>, default=<span class="stringliteral">&quot; &quot;</span>)</div><div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;  <span class="keyword">call </span>get_param(param_file, mod, <span class="stringliteral">&quot;OFF_SUM_FILE&quot;</span>, cs%sum_file, &amp;</div><div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;    <span class="stringliteral">&quot;Filename where the accumulated fields can be found&quot;</span>, default = <span class="stringliteral">&quot; &quot;</span>)</div><div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;  <span class="keyword">call </span>get_param(param_file, mod, <span class="stringliteral">&quot;OFF_SNAP_FILE&quot;</span>, cs%snap_file, &amp;</div><div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;    <span class="stringliteral">&quot;Filename where snapshot fields can be found&quot;</span>,default=<span class="stringliteral">&quot; &quot;</span>)</div><div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;  <span class="keyword">call </span>get_param(param_file, mod, <span class="stringliteral">&quot;START_INDEX&quot;</span>, cs%start_index, &amp;</div><div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;    <span class="stringliteral">&quot;Which time index to start from&quot;</span>, default=1)</div><div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;  <span class="keyword">call </span>get_param(param_file, mod, <span class="stringliteral">&quot;NUMTIME&quot;</span>, cs%numtime, &amp;</div><div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;    <span class="stringliteral">&quot;Number of timelevels in offline input files&quot;</span>, default=0)</div><div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;  <span class="keyword">call </span>get_param(param_file, mod, <span class="stringliteral">&quot;FIELDS_ARE_OFFSET&quot;</span>, cs%fields_are_offset, &amp;</div><div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;    <span class="stringliteral">&quot;True if the time-averaged fields and snapshot fields\n&quot;</span>//&amp;</div><div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;    <span class="stringliteral">&quot;are offset by one time level&quot;</span>, default=.false.)</div><div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;  <span class="keyword">call </span>get_param(param_file, mod, <span class="stringliteral">&quot;REDISTRIBUTE_METHOD&quot;</span>, cs%redistribute_method, &amp;</div><div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;    <span class="stringliteral">&quot;Redistributes any remaining horizontal fluxes throughout\n&quot;</span>//&amp;</div><div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;    <span class="stringliteral">&quot;the rest of water column. Options are &#39;barotropic&#39; which\n&quot;</span>//&amp;</div><div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;    <span class="stringliteral">&quot;evenly distributes flux throughout the entire water column,\n&quot;</span>//&amp;</div><div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;    <span class="stringliteral">&quot;&#39;upwards&#39; which adds the maximum of the remaining flux in\n&quot;</span>//&amp;</div><div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;    <span class="stringliteral">&quot;each layer above, and &#39;none&#39; which does no redistribution&quot;</span>, &amp;</div><div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;    default=<span class="stringliteral">&#39;barotropic&#39;</span>)  </div><div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;  <span class="keyword">call </span>get_param(param_file, mod, <span class="stringliteral">&quot;NUM_OFF_ITER&quot;</span>, cs%num_off_iter, &amp;</div><div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;    <span class="stringliteral">&quot;Number of iterations to subdivide the offline tracer advection and diffusion&quot;</span> )</div><div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;  <span class="keyword">call </span>get_param(param_file, mod, <span class="stringliteral">&quot;DT_OFFLINE&quot;</span>, cs%dt_offline, &amp;</div><div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;    <span class="stringliteral">&quot;Length of the offline timestep&quot;</span>)</div><div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;</div><div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;  <span class="comment">! Concatenate offline directory and file names</span></div><div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;  cs%snap_file = trim(cs%offlinedir)//trim(cs%snap_file)</div><div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;  cs%sum_file = trim(cs%offlinedir)//trim(cs%sum_file)</div><div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;</div><div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;  <span class="comment">! Set the starting read index for time-averaged and snapshotted fields</span></div><div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;  cs%ridx_sum = cs%start_index</div><div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;  <span class="keywordflow">if</span>(cs%fields_are_offset) cs%ridx_snap = next_modulo_time(cs%start_index,cs%numtime)</div><div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;  <span class="keywordflow">if</span>(.not. cs%fields_are_offset) cs%ridx_snap = cs%start_index</div><div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;</div><div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;  <span class="comment">! Copy over parameters from other control structures</span></div><div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;  <span class="keywordflow">if</span>(<span class="keyword">associated</span>(diabatic_aux_csp)) <span class="keywordflow">then</span></div><div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;    cs%evap_CFL_limit = diabatic_aux_csp%evap_CFL_limit</div><div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;    cs%minimum_forcing_depth = diabatic_aux_csp%minimum_forcing_depth</div><div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;</div><div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;  <span class="keyword">call </span>calltree_leave(<span class="stringliteral">&quot;offline_transport_init&quot;</span>)</div><div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;</div></div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="../../d1/d36/namespacemom__offline__transport_a44091358f321c2eeb97e5542d2176446_cgraph.svg" width="360" height="52"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>

</div>
</div>
<a id="a19ed8ea04e4800c60378abffb5757d7c"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a19ed8ea04e4800c60378abffb5757d7c">&sect;&nbsp;</a></span>register_diags_offline_transport()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_offline_transport::register_diags_offline_transport </td>
          <td>(</td>
          <td class="paramtype">type(time_type), intent(in)&#160;</td>
          <td class="paramname"><em>Time</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(diag_ctrl)&#160;</td>
          <td class="paramname"><em>diag</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="../../d0/d2c/structmom__offline__transport_1_1offline__transport__cs.html">offline_transport_cs</a>), pointer&#160;</td>
          <td class="paramname"><em>CS</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Initialize additional diagnostics required for offline tracer transport. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir"></td><td class="paramname">cs</td><td>control structure for MOM</td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">time</td><td>current model time </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="../../de/df1/MOM__offline__control_8F90_source.html#l00213">213</a> of file <a class="el" href="../../de/df1/MOM__offline__control_8F90_source.html">MOM_offline_control.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;</div><div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;  <span class="keywordtype">type</span>(offline_transport_cs), <span class="keywordtype">pointer</span> :: cs<span class="comment">         !&lt; control structure for MOM</span></div><div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;  <span class="keywordtype">type</span>(time_type), <span class="keywordtype">intent(in)</span> :: time<span class="comment">               !&lt; current model time</span></div><div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;  <span class="keywordtype">type</span>(diag_ctrl)             :: diag</div><div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;</div><div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;</div><div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;  <span class="comment">! U-cell fields</span></div><div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;  cs%id_uhr = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;uhr&#39;</span>, diag%axesCuL, time, &amp;</div><div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;    <span class="stringliteral">&#39;Zonal thickness fluxes remaining at end of timestep&#39;</span>, <span class="stringliteral">&#39;kg&#39;</span>)</div><div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;  cs%id_uhr_redist = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;uhr_redist&#39;</span>, diag%axesCuL, time, &amp;</div><div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;    <span class="stringliteral">&#39;Zonal thickness fluxes to be redistributed vertically&#39;</span>, <span class="stringliteral">&#39;kg&#39;</span>)  </div><div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;</div><div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;  <span class="comment">! V-cell fields</span></div><div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;  cs%id_vhr = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;vhr&#39;</span>, diag%axesCvL, time, &amp;</div><div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;    <span class="stringliteral">&#39;Meridional thickness fluxes remaining at end of timestep&#39;</span>, <span class="stringliteral">&#39;kg&#39;</span>)</div><div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;  cs%id_vhr_redist = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;vhr_redist&#39;</span>, diag%axesCvL, time, &amp;</div><div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;    <span class="stringliteral">&#39;Meridional thickness to be redistributed vertically&#39;</span>, <span class="stringliteral">&#39;kg&#39;</span>)</div><div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;</div><div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;  <span class="comment">! T-cell fields</span></div><div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;  cs%id_hr  = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;hdiff&#39;</span>, diag%axesTL, time, &amp;</div><div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;    <span class="stringliteral">&#39;Difference between the stored and calculated layer thickness&#39;</span>, <span class="stringliteral">&#39;m&#39;</span>)</div><div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;  cs%id_ear  = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;ear&#39;</span>, diag%axesTL, time, &amp;</div><div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;    <span class="stringliteral">&#39;Remaining thickness entrained from above&#39;</span>, <span class="stringliteral">&#39;m&#39;</span>)</div><div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;  cs%id_ebr  = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>, <span class="stringliteral">&#39;ebr&#39;</span>, diag%axesTL, time, &amp;</div><div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;    <span class="stringliteral">&#39;Remaining thickness entrained from below&#39;</span>, <span class="stringliteral">&#39;m&#39;</span>)</div><div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;  cs%id_eta_diff = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>,<span class="stringliteral">&#39;eta_diff&#39;</span>, diag%axesT1, time, &amp;</div><div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;    <span class="stringliteral">&#39;Difference in total water column height from online and offline&#39;</span>,<span class="stringliteral">&#39;m&#39;</span>)</div><div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;  cs%id_h_redist = register_diag_field(<span class="stringliteral">&#39;ocean_model&#39;</span>,<span class="stringliteral">&#39;h_redist&#39;</span>, diag%axesTL, time, &amp;</div><div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;    <span class="stringliteral">&#39;Layer thicknesses before redistribution of mass fluxes&#39;</span>,<span class="stringliteral">&#39;m&#39;</span>)  </div><div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;</div></div><!-- fragment -->
</div>
</div>
<a id="a60b8cb34d18c91e1e965b21b0cc65ce5"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a60b8cb34d18c91e1e965b21b0cc65ce5">&sect;&nbsp;</a></span>transport_by_files()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_offline_transport::transport_by_files </td>
          <td>(</td>
          <td class="paramtype">type(ocean_grid_type), intent(inout)&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), intent(inout)&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(<a class="el" href="../../d0/d2c/structmom__offline__transport_1_1offline__transport__cs.html">offline_transport_cs</a>), intent(inout)&#160;</td>
          <td class="paramname"><em>CS</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(g))&#160;</td>
          <td class="paramname"><em>h_end</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(g))&#160;</td>
          <td class="paramname"><em>eatr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(g))&#160;</td>
          <td class="paramname"><em>ebtr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szib_(g),szj_(g),szk_(g))&#160;</td>
          <td class="paramname"><em>uhtr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szjb_(g),szk_(g))&#160;</td>
          <td class="paramname"><em>vhtr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szib_(g),szj_(g))&#160;</td>
          <td class="paramname"><em>khdt_x</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szjb_(g))&#160;</td>
          <td class="paramname"><em>khdt_y</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(g))&#160;</td>
          <td class="paramname"><em>temp</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(g))&#160;</td>
          <td class="paramname"><em>salt</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(forcing)&#160;</td>
          <td class="paramname"><em>fluxes</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">logical, optional&#160;</td>
          <td class="paramname"><em>do_ale_in</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Controls the reading in 3d mass fluxes, diffusive fluxes, and other fields stored in a previous integration of the online model. </p>

<p>Definition at line <a class="el" href="../../de/df1/MOM__offline__control_8F90_source.html#l00083">83</a> of file <a class="el" href="../../de/df1/MOM__offline__control_8F90_source.html">MOM_offline_control.F90</a>.</p>

<p>References <a class="el" href="../../d5/d48/MOM__error__handler_8F90_source.html#l00125">mom_error_handler::calltree_enter()</a>, and <a class="el" href="../../de/df1/MOM__offline__control_8F90_source.html#l00323">next_modulo_time()</a>.</p>
<div class="fragment"><div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;</div><div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;  <span class="keywordtype">type</span>(ocean_grid_type),                     <span class="keywordtype">intent(inout)</span>    :: g</div><div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;  <span class="keywordtype">type</span>(verticalgrid_type),                   <span class="keywordtype">intent(inout)</span>    :: gv</div><div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;  <span class="keywordtype">type</span>(offline_transport_cs),                <span class="keywordtype">intent(inout)</span>    :: cs</div><div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;  <span class="keywordtype">logical</span>, <span class="keywordtype">optional</span>                                           :: do_ale_in</div><div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;</div><div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;  <span class="comment">!! Mandatory variables</span></div><div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;  <span class="comment">! Fields at U-points</span></div><div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;  <span class="comment">!  3D</span></div><div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZIB_(G),SZJ_(G),SZK_(G))</span>                   :: uhtr</div><div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;  <span class="comment">!  2D</span></div><div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZIB_(G),SZJ_(G))</span>                           :: khdt_x</div><div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;  <span class="comment">! Fields at V-points</span></div><div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;  <span class="comment">!  3D</span></div><div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJB_(G),SZK_(G))</span>                   :: vhtr</div><div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;  <span class="comment">!  2D</span></div><div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJB_(G))</span>                           :: khdt_y</div><div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;  <span class="comment">! Fields at T-point</span></div><div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span> :: &amp;</div><div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;    h_end, &amp;</div><div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;    eatr, ebtr, &amp;</div><div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;    temp, salt</div><div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;  <span class="keywordtype">type</span>(forcing)                                               :: fluxes</div><div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;  <span class="keywordtype">logical</span>                                                     :: do_ale</div><div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;  <span class="keywordtype">integer</span> :: i, j, k, is, ie, js, je, nz</div><div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;</div><div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;  do_ale = .false.;</div><div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">present</span>(do_ale_in) ) do_ale = do_ale_in</div><div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;</div><div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;  is   = g%isc   ; ie   = g%iec  ; js   = g%jsc  ; je   = g%jec ; nz = gv%ke</div><div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;</div><div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;</div><div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;  <span class="keyword">call </span>calltree_enter(<span class="stringliteral">&quot;transport_by_files, MOM_offline_control.F90&quot;</span>)</div><div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;</div><div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;</div><div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;  <span class="comment">!! Time-summed fields</span></div><div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;  <span class="comment">! U-grid</span></div><div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;  <span class="keyword">call </span>read_data(cs%sum_file, <span class="stringliteral">&#39;uhtr_sum&#39;</span>,     uhtr,domain=g%Domain%mpp_domain, &amp;</div><div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;    timelevel=cs%ridx_sum,position=east)</div><div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;  <span class="keyword">call </span>read_data(cs%sum_file, <span class="stringliteral">&#39;khdt_x_sum&#39;</span>, khdt_x,domain=g%Domain%mpp_domain, &amp;</div><div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;    timelevel=cs%ridx_sum,position=east)</div><div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;  <span class="comment">! V-grid</span></div><div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;  <span class="keyword">call </span>read_data(cs%sum_file, <span class="stringliteral">&#39;vhtr_sum&#39;</span>,     vhtr, domain=g%Domain%mpp_domain, &amp;</div><div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;    timelevel=cs%ridx_sum,position=north)</div><div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;  <span class="keyword">call </span>read_data(cs%sum_file, <span class="stringliteral">&#39;khdt_y_sum&#39;</span>, khdt_y, domain=g%Domain%mpp_domain, &amp;</div><div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;    timelevel=cs%ridx_sum,position=north)</div><div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;  <span class="comment">! T-grid</span></div><div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;  <span class="keyword">call </span>read_data(cs%sum_file, <span class="stringliteral">&#39;ea_sum&#39;</span>,   eatr, domain=g%Domain%mpp_domain, &amp;</div><div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;    timelevel=cs%ridx_sum,position=center)</div><div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;  <span class="keyword">call </span>read_data(cs%sum_file, <span class="stringliteral">&#39;eb_sum&#39;</span>,   ebtr, domain=g%Domain%mpp_domain, &amp;</div><div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;    timelevel=cs%ridx_sum,position=center)</div><div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;</div><div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;  <span class="comment">!! Time-averaged fields</span></div><div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;  <span class="keyword">call </span>read_data(cs%snap_file, <span class="stringliteral">&#39;temp&#39;</span>,   temp, domain=g%Domain%mpp_domain, &amp;</div><div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;    timelevel=cs%ridx_sum,position=center)</div><div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;  <span class="keyword">call </span>read_data(cs%snap_file, <span class="stringliteral">&#39;salt&#39;</span>,   salt, domain=g%Domain%mpp_domain, &amp;</div><div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;    timelevel=cs%ridx_sum,position=center)</div><div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;</div><div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;  <span class="comment">!! Read snapshot fields (end of time interval timestamp)</span></div><div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;  <span class="keyword">call </span>read_data(cs%snap_file, <span class="stringliteral">&#39;h_end&#39;</span>, h_end, domain=g%Domain%mpp_domain, &amp;</div><div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;    timelevel=cs%ridx_snap,position=center)</div><div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;</div><div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;  <span class="comment">! Apply masks at T, U, and V points</span></div><div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;  <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;    <span class="keywordflow">if</span>(g%mask2dT(i,j)&lt;1.0) <span class="keywordflow">then</span></div><div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;      h_end(i,j,k) = gv%Angstrom</div><div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;      eatr(i,j,k) = 0.0</div><div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;      ebtr(i,j,k) = 0.0</div><div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;<span class="keyword">  end</span>do; enddo ; enddo</div><div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;</div><div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;  <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> j=js-1,je ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;    <span class="keywordflow">if</span>(g%mask2dCv(i,j)&lt;1.0) <span class="keywordflow">then</span></div><div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;      khdt_y(i,j) = 0.0</div><div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;      vhtr(i,j,k) = 0.0</div><div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;<span class="keyword">  end</span>do; enddo ; enddo</div><div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;</div><div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;  <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=is-1,ie</div><div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;    <span class="keywordflow">if</span>(g%mask2dCu(i,j)&lt;1.0) <span class="keywordflow">then</span></div><div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;      khdt_x(i,j) = 0.0</div><div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;      uhtr(i,j,k) = 0.0</div><div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;<span class="keyword">  end</span>do; enddo ; enddo</div><div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;</div><div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;  <span class="comment">! This block makes sure that the fluxes control structure, which may not be used in the solo_driver,</span></div><div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;  <span class="comment">! contains netMassIn and netMassOut which is necessary for the applyTracerBoundaryFluxesInOut routine</span></div><div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;  <span class="keywordflow">if</span> (do_ale) <span class="keywordflow">then</span></div><div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;    <span class="keywordflow">if</span> (.not. <span class="keyword">ASSOCIATED</span>(fluxes%netMassOut)) <span class="keywordflow">then</span></div><div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;      <span class="keyword">ALLOCATE</span>(fluxes%netMassOut(g%isd:g%ied,g%jsd:g%jed))</div><div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;      fluxes%netMassOut(:,:) = 0.0</div><div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;    <span class="keywordflow">if</span> (.not. <span class="keyword">ASSOCIATED</span>(fluxes%netMassIn)) <span class="keywordflow">then</span></div><div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;      <span class="keyword">ALLOCATE</span>(fluxes%netMassIn(g%isd:g%ied,g%jsd:g%jed))</div><div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;      fluxes%netMassIn(:,:) = 0.0</div><div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;</div><div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;    <span class="keyword">call </span>read_data(cs%sum_file,<span class="stringliteral">&#39;massout_flux_sum&#39;</span>,fluxes%netMassOut, domain=g%Domain%mpp_domain, &amp;</div><div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;        timelevel=cs%ridx_snap,position=center)</div><div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;    <span class="keyword">call </span>read_data(cs%sum_file,<span class="stringliteral">&#39;massin_flux_sum&#39;</span>, fluxes%netMassIn,  domain=g%Domain%mpp_domain, &amp;</div><div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;        timelevel=cs%ridx_snap,position=center)</div><div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;</div><div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;  <span class="comment">!! Make sure all halos have been updated</span></div><div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;  <span class="comment">! Vector fields</span></div><div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;  <span class="keyword">call </span>pass_vector(uhtr, vhtr, g%Domain)</div><div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;  <span class="keyword">call </span>pass_vector(khdt_x, khdt_y, g%Domain)</div><div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;</div><div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;  <span class="comment">! Scalar fields</span></div><div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;  <span class="keyword">call </span>pass_var(h_end, g%Domain)</div><div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;  <span class="keyword">call </span>pass_var(eatr, g%Domain)</div><div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;  <span class="keyword">call </span>pass_var(ebtr, g%Domain)</div><div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;  <span class="keyword">call </span>pass_var(temp, g%Domain)</div><div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;  <span class="keyword">call </span>pass_var(salt, g%Domain)</div><div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;</div><div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;  <span class="keywordflow">if</span> (do_ale) <span class="keywordflow">then</span></div><div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;    <span class="keyword">call </span>pass_var(fluxes%netMassOut,g%Domain)</div><div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;    <span class="keyword">call </span>pass_var(fluxes%netMassIn,g%Domain)</div><div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;</div><div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;  <span class="comment">! Update the read indices</span></div><div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;  cs%ridx_snap = next_modulo_time(cs%ridx_snap,cs%numtime)</div><div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;  cs%ridx_sum = next_modulo_time(cs%ridx_sum,cs%numtime)</div><div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;</div><div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;  <span class="keyword">call </span>calltree_leave(<span class="stringliteral">&quot;transport_by_file&quot;</span>)</div><div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;</div></div><!-- fragment --><div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" frameborder="0" src="../../d1/d36/namespacemom__offline__transport_a60b8cb34d18c91e1e965b21b0cc65ce5_cgraph.svg" width="550" height="118"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>

</div>
</div>
<a id="a5359757456636e62aae1954e7bc54921"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a5359757456636e62aae1954e7bc54921">&sect;&nbsp;</a></span>update_h_horizontal_flux()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_offline_transport::update_h_horizontal_flux </td>
          <td>(</td>
          <td class="paramtype">type(ocean_grid_type), pointer&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), pointer&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szib_(g),szj_(g),szk_(g)), intent(in)&#160;</td>
          <td class="paramname"><em>uhtr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szjb_(g),szk_(g)), intent(in)&#160;</td>
          <td class="paramname"><em>vhtr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(g)), intent(in)&#160;</td>
          <td class="paramname"><em>h_pre</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(g)), intent(inout)&#160;</td>
          <td class="paramname"><em>h_new</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>This updates thickness based on the convergence of horizontal mass fluxes NOTE: Only used in non-ALE mode. </p>

<p>Definition at line <a class="el" href="../../de/df1/MOM__offline__control_8F90_source.html#l00343">343</a> of file <a class="el" href="../../de/df1/MOM__offline__control_8F90_source.html">MOM_offline_control.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;  <span class="keywordtype">type</span>(ocean_grid_type),    <span class="keywordtype">pointer</span>                           :: g</div><div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;  <span class="keywordtype">type</span>(verticalgrid_type),  <span class="keywordtype">pointer</span>                           :: gv</div><div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZIB_(G),SZJ_(G),SZK_(G))</span>, <span class="keywordtype">intent(in)</span>       :: uhtr</div><div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJB_(G),SZK_(G))</span>, <span class="keywordtype">intent(in)</span>       :: vhtr</div><div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span> , <span class="keywordtype">intent(in)</span>       :: h_pre</div><div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span> , <span class="keywordtype">intent(inout)</span>    :: h_new</div><div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;</div><div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;  <span class="comment">! Local variables</span></div><div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;  <span class="keywordtype">integer</span> :: i, j, k, m, is, ie, js, je, nz</div><div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;  <span class="comment">! Set index-related variables for fields on T-grid</span></div><div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;  is  = g%isc ; ie  = g%iec ; js  = g%jsc ; je  = g%jec ; nz = gv%ke</div><div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;</div><div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;  <span class="keywordflow">do</span> k = 1, nz</div><div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;    <span class="keywordflow">do</span> i=is-1,ie+1 ; <span class="keywordflow">do</span> j=js-1,je+1</div><div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;</div><div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;      h_new(i,j,k) = max(0.0, g%areaT(i,j)*h_pre(i,j,k) + &amp;</div><div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;        ((uhtr(i-1,j,k) - uhtr(i,j,k)) + (vhtr(i,j-1,k) - vhtr(i,j,k))))</div><div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;</div><div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;      <span class="comment">! In the case that the layer is now dramatically thinner than it was previously,</span></div><div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;      <span class="comment">! add a bit of mass to avoid truncation errors.  This will lead to</span></div><div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;      <span class="comment">! non-conservation of tracers</span></div><div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;      h_new(i,j,k) = h_new(i,j,k) + &amp;</div><div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;        max(gv%Angstrom, 1.0e-13*h_new(i,j,k) - g%areaT(i,j)*h_pre(i,j,k))</div><div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;</div><div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;      <span class="comment">! Convert back to thickness</span></div><div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;      h_new(i,j,k) = h_new(i,j,k)/g%areaT(i,j)</div><div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;</div><div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;<span class="keywordflow">  enddo</span></div></div><!-- fragment -->
</div>
</div>
<a id="a60a9bf9d4ab918807053d21f973ed6f0"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a60a9bf9d4ab918807053d21f973ed6f0">&sect;&nbsp;</a></span>update_h_vertical_flux()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine, public mom_offline_transport::update_h_vertical_flux </td>
          <td>(</td>
          <td class="paramtype">type(ocean_grid_type), pointer&#160;</td>
          <td class="paramname"><em>G</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">type(verticalgrid_type), pointer&#160;</td>
          <td class="paramname"><em>GV</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(g)), intent(in)&#160;</td>
          <td class="paramname"><em>ea</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(g)), intent(in)&#160;</td>
          <td class="paramname"><em>eb</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(g)), intent(in)&#160;</td>
          <td class="paramname"><em>h_pre</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real, dimension(szi_(g),szj_(g),szk_(g)), intent(inout)&#160;</td>
          <td class="paramname"><em>h_new</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Updates layer thicknesses due to vertical mass transports NOTE: Only used in non-ALE configuration. </p>

<p>Definition at line <a class="el" href="../../de/df1/MOM__offline__control_8F90_source.html#l00377">377</a> of file <a class="el" href="../../de/df1/MOM__offline__control_8F90_source.html">MOM_offline_control.F90</a>.</p>
<div class="fragment"><div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;  <span class="keywordtype">type</span>(ocean_grid_type),    <span class="keywordtype">pointer</span>                           :: g</div><div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;  <span class="keywordtype">type</span>(verticalgrid_type),  <span class="keywordtype">pointer</span>                           :: gv</div><div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span> , <span class="keywordtype">intent(in)</span>       :: ea</div><div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span> , <span class="keywordtype">intent(in)</span>       :: eb</div><div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span> , <span class="keywordtype">intent(in)</span>       :: h_pre</div><div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;  <span class="keywordtype">real</span>, <span class="keywordtype">dimension(SZI_(G),SZJ_(G),SZK_(G))</span> , <span class="keywordtype">intent(inout)</span>    :: h_new</div><div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;</div><div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;  <span class="comment">! Local variables</span></div><div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;  <span class="keywordtype">integer</span> :: i, j, k, m, is, ie, js, je, nz</div><div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;  <span class="comment">! Set index-related variables for fields on T-grid</span></div><div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;  is  = g%isc ; ie  = g%iec ; js  = g%jsc ; je  = g%jec ; nz = gv%ke</div><div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;</div><div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;  <span class="comment">! Update h_new with convergence of vertical mass transports</span></div><div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;  <span class="keywordflow">do</span> j=js-1,je+1</div><div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;    <span class="keywordflow">do</span> i=is-1,ie+1</div><div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;</div><div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;      <span class="comment">! Top layer</span></div><div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;      h_new(i,j,1) = max(0.0, h_pre(i,j,1) + (eb(i,j,1) - ea(i,j,2) + ea(i,j,1) ))</div><div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;      h_new(i,j,1) = h_new(i,j,1) + &amp;</div><div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;          max(0.0, 1.0e-13*h_new(i,j,1) - h_pre(i,j,1))</div><div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;</div><div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;      <span class="comment">! Bottom layer</span></div><div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;<span class="comment">!        h_new(i,j,nz) = h_pre(i,j,nz) + (ea(i,j,nz) - eb(i,j,nz-1)+eb(i,j,nz))</span></div><div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;      h_new(i,j,nz) = max(0.0, h_pre(i,j,nz) + (ea(i,j,nz) - eb(i,j,nz-1)+eb(i,j,nz)))</div><div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;      h_new(i,j,nz) = h_new(i,j,nz) + &amp;</div><div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;          max(0.0, 1.0e-13*h_new(i,j,nz) - h_pre(i,j,nz))</div><div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;</div><div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;<span class="keywordflow">    enddo</span></div><div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;</div><div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;    <span class="comment">! Interior layers</span></div><div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;    <span class="keywordflow">do</span> k=2,nz-1 ; <span class="keywordflow">do</span> i=is-1,ie+1</div><div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;</div><div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;      h_new(i,j,k) = max(0.0, h_pre(i,j,k) + ((ea(i,j,k) - eb(i,j,k-1)) + &amp;</div><div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;          (eb(i,j,k) - ea(i,j,k+1))))</div><div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;      h_new(i,j,k) = h_new(i,j,k) + &amp;</div><div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;        max(0.0, 1.0e-13*h_new(i,j,k) - h_pre(i,j,k))</div><div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;</div><div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;</div><div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;<span class="keywordflow">  enddo</span></div><div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;</div></div><!-- fragment -->
</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../d1/d36/namespacemom__offline__transport.html">mom_offline_transport</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
