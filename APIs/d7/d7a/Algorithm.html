<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MOM6: Dynamics Algorithm</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">MOM6
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('d7/d7a/Algorithm.html','../../');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Dynamics Algorithm </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1>A single dynamics step of Runge-Kutta split time-stepping</h1>
<h2>Algorithm in equations</h2>
<p class="formulaDsp">
\begin{eqnarray*} \left( \text{PFu}, \text{PFv} \right) &amp; = &amp; \left( - \frac{1}{\rho_o} \partial_x p, - \frac{1}{\rho_o} \partial_y p \right) \\ \zeta &amp; = &amp; \partial_x &lt;v&gt; - \partial_y &lt;u&gt; \\ KE &amp; = &amp; \frac{1}{2} \left( &lt;u&gt;^2 + &lt;v&gt;^2 \right) \\ \left( \text{Cau}, \text{Cav} \right) &amp; = &amp; \left( \frac{f+\zeta}{&lt;h&gt;} (vh) - \partial_x KE , -\frac{f+\zeta}{&lt;h&gt;} (uh) - \partial_y KE \right) \\ \left( \dot{u}_{bc} , \dot{v}_{bc} \right) &amp; = &amp; \left( Cau + PFu + diffu(u[n-1]) , Cav + PFv + diffv(v[n-1]) \right) \\ up &amp; = &amp; u + \Delta t \dot{u}_{bc} \\ vp &amp; = &amp; v + \Delta t \dot{v}_{bc} \\ hp &amp; = &amp; h + \Delta t \left( \partial_x ( u h ) + \partial_y ( v h ) \right) \\ \left( uh_{bt} , vh_{bt} \right) &amp; = &amp; \left( &lt; U H &gt; , &lt; V H &gt; \right) \\ \eta_{pred} &amp; = &amp; \eta^{n-1} + \Delta t \left( \partial_x &lt; U H &gt; + \partial_y &lt; V H &gt; \right) \\ \left( up , vp \right) &amp; = &amp; \left( u + b_e \Delta t \left( \dot{u}_{bc} + \dot{u}_{bt} \right) v + b_e \Delta t \left( \dot{v}_{bc} + \dot{v}_{bt} \right) \right) \\ \left( \left[ 1 + \Delta t \partial_z \nu \partial_z \right] up , \left[ 1 + \Delta t \partial_z \nu \partial_z \right] vp \right) &amp; \leftarrow &amp; \left( up , vp \right) \\ hp &amp; = &amp; h + \Delta t \left( \partial_x ( u h ) + \partial_y ( v h ) \right) \\ \end{eqnarray*}
</p>
<h2>Algorithm following the code</h2>
<p>The Runge-Kutta split time-step is implemented in subroutine <a class="el" href="../../d1/dc3/namespacemom__dynamics__split__rk2.html#a81cce65643a8cf94979d68354a9a1979" title="RK2 splitting for time stepping MOM adiabatic dynamics. ">step_mom_dyn_split_rk2()</a> in module <a class="el" href="../../d1/dc3/namespacemom__dynamics__split__rk2.html">MOM_dynamics_split_RK2</a> in file <a class="el" href="../../dc/d1a/MOM__dynamics__split__RK2_8F90.html">MOM_dynamics_split_RK2.F90</a>.</p>
<p>The full pressure force (including baroclinic and barotropic contributions) is calculated by subroutine <a class="el" href="../../d6/d5c/namespacemom__pressureforce.html#a9f010455182eeaa61c9f01caff250bf8">pressureforce()</a> which is passed <code>h</code> and <code>tv</code> and returns <code>PFu</code>, <code>PFv</code>, <code>pbce</code> and <code>eta_PF</code>: </p><p class="formulaDsp">
\begin{eqnarray*} \left( \text{PFu}, \text{PFv} \right) &amp; = &amp; \left( - \frac{1}{\rho_o} \partial_x p, - \frac{1}{\rho_o} \partial_y p \right) \\ \end{eqnarray*}
</p>
<div class="fragment"><div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;  <span class="comment">! PFu = d/dx M(h,T,S)</span></div><div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;  <span class="comment">! pbce = dM/deta</span></div><div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;  <span class="keywordflow">if</span> (cs%begw == 0.0) <span class="keyword">call </span>enable_averaging(dt, time_local, cs%diag)</div><div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;  <span class="keyword">call </span>cpu_clock_begin(id_clock_pres)</div><div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;  <span class="keyword">call </span>pressureforce(h, tv, cs%PFu, cs%PFv, g, gv, cs%PressureForce_CSp, &amp;</div><div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;                     cs%ALE_CSp, p_surf, cs%pbce, cs%eta_PF)</div><div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;  <span class="keywordflow">if</span> (cs%debug) <span class="keywordflow">then</span></div><div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;    <span class="keyword">call </span>uchksum(cs%PFu,<span class="stringliteral">&quot;After PressureForce CS%PFu&quot;</span>,g%HI,haloshift=0)</div><div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;    <span class="keyword">call </span>vchksum(cs%PFv,<span class="stringliteral">&quot;After PressureForce CS%PFv&quot;</span>,g%HI,haloshift=0)</div><div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;</div><div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;  <span class="keywordflow">if</span> (dyn_p_surf) <span class="keywordflow">then</span></div><div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;    pa_to_eta = 1.0 / gv%H_to_Pa</div><div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;<span class="comment">!$OMP parallel do default(none) shared(Isq,Ieq,Jsq,Jeq,eta_PF_start,CS,Pa_to_eta,p_surf_begin,p_surf_end)</span></div><div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;    <span class="keywordflow">do</span> j=jsq,jeq+1 ; <span class="keywordflow">do</span> i=isq,ieq+1</div><div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;      eta_pf_start(i,j) = cs%eta_PF(i,j) - pa_to_eta * &amp;</div><div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;                          (p_surf_begin(i,j) - p_surf_end(i,j))</div><div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;  <span class="keyword">call </span>cpu_clock_end(id_clock_pres)</div><div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;  <span class="keyword">call </span>disable_averaging(cs%diag)</div><div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;  <span class="keywordflow">if</span> (showcalltree) <span class="keyword">call </span>calltree_waypoint(<span class="stringliteral">&quot;done with PressureForce (step_MOM_dyn_split_RK2)&quot;</span>)</div></div><!-- fragment --><p>Subroutine <a class="el" href="../../d8/dd2/namespacemom__coriolisadv.html#a48e46860dad5118d78c8cd7de964e71f" title="Calculates the Coriolis and momentum advection contributions to the acceleration. ...">coradcalc()</a> returns <code>Cau</code> and <code>Cav</code> the accelerations due to Coriolis and momentum advection: </p><p class="formulaDsp">
\begin{eqnarray*} \zeta &amp; = &amp; \partial_x &lt;v&gt; - \partial_y &lt;u&gt; \\ KE &amp; = &amp; \frac{1}{2} \left( &lt;u&gt;^2 + &lt;v&gt;^2 \right) \\ \left( \text{Cau}, \text{Cav} \right) &amp; = &amp; \left( \frac{f+\zeta}{&lt;h&gt;} (vh) - \partial_x KE , -\frac{f+\zeta}{&lt;h&gt;} (uh) - \partial_y KE \right) \\ \end{eqnarray*}
</p>
 <dl class="todo"><dt><b><a class="el" href="../../dd/da0/todo.html#_todo000001">Todo:</a></b></dt><dd>Where do uh and vh come from?</dd></dl>
<p>In these calculations, variables <code>u_av</code> and <code>v_av</code> are the time-averages \(&lt;u&gt;\) and \(&lt;v&gt;\) from the previous time step. To avoid an large imbalance of terms, the horizontal-viscosity accelerations from the last time-step are used (<code>diffu</code> and <code>diffv</code>).</p>
<div class="fragment"><div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;  <span class="comment">! CAu = -(f+zeta_av)/h_av vh + d/dx KE_av</span></div><div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;  <span class="comment">! CAv =  (f+zeta_av)/h_av uh + d/dy KE_av</span></div><div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;  <span class="keyword">call </span>cpu_clock_begin(id_clock_cor)</div><div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;  <span class="keyword">call </span>coradcalc(u_av, v_av, h_av, uh, vh, cs%CAu, cs%CAv, cs%OBC, cs%ADp, &amp;</div><div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;                 g, gv, cs%CoriolisAdv_CSp)</div><div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;  <span class="keyword">call </span>cpu_clock_end(id_clock_cor)</div><div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;  <span class="keywordflow">if</span> (showcalltree) <span class="keyword">call </span>calltree_waypoint(<span class="stringliteral">&quot;done with CorAdCalc (step_MOM_dyn_split_RK2)&quot;</span>)</div></div><!-- fragment --><p>All explicit "baroclinic" accelerations are added up ready to pass to the barotropic solver: </p><p class="formulaDsp">
\begin{eqnarray*} \left( \dot{u}_{bc} , \dot{v}_{bc} \right) &amp; = &amp; \left( Cau + PFu + diffu(u[n-1]) , Cav + PFv + diffv(v[n-1]) \right) \\ \end{eqnarray*}
</p>
 <div class="fragment"><div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;  <span class="comment">! u_bc_accel = CAu + PFu + diffu(u[n-1])</span></div><div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;  <span class="comment">! v_bc_accel = CAv + PFv + diffv(v[n-1])</span></div><div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;  <span class="keyword">call </span>cpu_clock_begin(id_clock_btforce)</div><div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;<span class="comment">!$OMP parallel do default(none) shared(is,ie,js,je,Isq,Ieq,Jsq,Jeq,nz,u_bc_accel,v_bc_accel,CS)</span></div><div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;  <span class="keywordflow">do</span> k=1,nz</div><div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;    <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=isq,ieq</div><div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;      u_bc_accel(i,j,k) = (cs%Cau(i,j,k) + cs%PFu(i,j,k)) + cs%diffu(i,j,k)</div><div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;    <span class="keywordflow">do</span> j=jsq,jeq ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;      v_bc_accel(i,j,k) = (cs%Cav(i,j,k) + cs%PFv(i,j,k)) + cs%diffv(i,j,k)</div><div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;<span class="keywordflow">  enddo</span></div><div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;  <span class="keyword">call </span>cpu_clock_end(id_clock_btforce)</div></div><!-- fragment --><p> And those explicit accelerations are used to predict a future velocity, stored in variables <code>up</code> and <code>vp</code>. </p><p class="formulaDsp">
\begin{eqnarray*} \left( up , vp \right) &amp; = &amp; \left( u + \Delta t \left( \dot{u}_{bc} + \dot{u}_{bt} \right) , v + \Delta t \left( \dot{v}_{bc} + \dot{v}_{bt} \right) \right) \end{eqnarray*}
</p>
<div class="fragment"><div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;  <span class="keyword">call </span>cpu_clock_begin(id_clock_vertvisc)</div><div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;<span class="comment">!$OMP parallel do default(none) shared(is,ie,js,je,Isq,Ieq,Jsq,Jeq,nz,up,G,u,dt, &amp;</span></div><div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;<span class="comment">!$OMP                                  u_bc_accel,vp,v,v_bc_accel)</span></div><div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;  <span class="keywordflow">do</span> k=1,nz</div><div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;    <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=isq,ieq</div><div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;      up(i,j,k) = g%mask2dCu(i,j) * (u(i,j,k) + dt * u_bc_accel(i,j,k))</div><div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;    <span class="keywordflow">do</span> j=jsq,jeq ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;      vp(i,j,k) = g%mask2dCv(i,j) * (v(i,j,k) + dt * v_bc_accel(i,j,k))</div><div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;<span class="keywordflow">  enddo</span></div></div><!-- fragment --><p>Vertical viscosity coefficients are calculated in subroutine <a class="el" href="../../d9/dcb/namespacemom__vert__friction.html#af2cc04944a1f4baa00c574d9ec082eeb" title="Calculate the coupling coefficients (CSa_u and CSa_v) and effective layer thicknesses (CSh_u and CSh_...">vertvisc_coef()</a> and stored in <code>csvertvisc_CSp</code>. Subroutine <a class="el" href="../../d9/dcb/namespacemom__vert__friction.html#acc0ab44f987baf2efee2f43fa54435f2" title="Calculate the fraction of momentum originally in a layer that remains after a time-step of viscosity...">vertvisc_remnant()</a> finds the profiles (<code>visc_rem_u</code>,<code>visc_rem_v</code>) of horizontal acceleration that the barotropic solver should provide after implicit vertical viscosity has been applied.</p>
<div class="fragment"><div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;  <span class="keyword">call </span>enable_averaging(dt, time_local, cs%diag)</div><div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;  <span class="keyword">call </span>set_viscous_ml(u, v, h, tv, fluxes, visc, dt, g, gv, &amp;</div><div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;                      cs%set_visc_CSp)</div><div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;  <span class="keyword">call </span>disable_averaging(cs%diag)</div><div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;</div><div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;  <span class="keywordflow">if</span> (cs%debug) <span class="keywordflow">then</span></div><div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;    <span class="keyword">call </span>uchksum(up,<span class="stringliteral">&quot;before vertvisc: up&quot;</span>,g%HI,haloshift=0)</div><div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;    <span class="keyword">call </span>vchksum(vp,<span class="stringliteral">&quot;before vertvisc: vp&quot;</span>,g%HI,haloshift=0)</div><div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;  <span class="keyword">call </span>vertvisc_coef(up, vp, h, fluxes, visc, dt, g, gv, cs%vertvisc_CSp)</div><div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;  <span class="keyword">call </span>vertvisc_remnant(visc, cs%visc_rem_u, cs%visc_rem_v, dt, g, gv, cs%vertvisc_CSp)</div><div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;  <span class="keyword">call </span>cpu_clock_end(id_clock_vertvisc)</div><div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;  <span class="keywordflow">if</span> (showcalltree) <span class="keyword">call </span>calltree_waypoint(<span class="stringliteral">&quot;done with vertvisc_coef (step_MOM_dyn_split_RK2)&quot;</span>)</div></div><!-- fragment --> <dl class="todo"><dt><b><a class="el" href="../../dd/da0/todo.html#_todo000002">Todo:</a></b></dt><dd>What is this call to <a class="el" href="../../d5/d7c/namespacemom__barotropic.html#a67277af6e92e3a6824edbbcc85ff9308">btcalc()</a> doing? <div class="fragment"><div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;  <span class="keyword">call </span>cpu_clock_begin(id_clock_btcalc)</div><div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;  <span class="comment">! Calculate the relative layer weights for determining barotropic quantities.</span></div><div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;  <span class="keywordflow">if</span> (.not.bt_cont_bt_thick) &amp;</div><div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;    <span class="keyword">call </span>btcalc(h, g, gv, cs%barotropic_CSp)</div><div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;  <span class="keyword">call </span>bt_mass_source(h, eta, fluxes, .true., dt_therm, dt_since_flux, &amp;</div><div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;                      g, gv, cs%barotropic_CSp)</div><div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;  <span class="keyword">call </span>cpu_clock_end(id_clock_btcalc)</div></div><!-- fragment --></dd></dl>
<p>The call to <a class="el" href="../../dd/da4/namespacemom__continuity.html#a483dba08c6a9574d7fe814cadccd870e" title="Time steps the layer thicknesses, using a monotonically limited, directionally split PPM scheme...">continuity()</a> calculates and linearises layer transports for the barotropic solver to use: </p><p class="formulaDsp">
\[ hp = h + \Delta t \left( \partial_x ( u h ) + \partial_y ( v h ) \right) \]
</p>
<div class="fragment"><div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">associated</span>(cs%BT_cont) .or. cs%BT_use_layer_fluxes) <span class="keywordflow">then</span></div><div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;    <span class="keyword">call </span>cpu_clock_begin(id_clock_continuity)</div><div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;    <span class="keyword">call </span>continuity(u, v, h, hp, uh_in, vh_in, dt, g, gv, &amp;</div><div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;                    cs%continuity_CSp, obc=cs%OBC, visc_rem_u=cs%visc_rem_u, &amp;</div><div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;                    visc_rem_v=cs%visc_rem_v, bt_cont=cs%BT_cont)</div><div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;    <span class="keyword">call </span>cpu_clock_end(id_clock_continuity)</div><div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;    <span class="keywordflow">if</span> (bt_cont_bt_thick) <span class="keywordflow">then</span></div><div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;      <span class="keyword">call </span>cpu_clock_begin(id_clock_pass)</div><div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;      <span class="keyword">call </span>do_group_pass(cs%pass_huv, g%Domain)</div><div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;      <span class="keyword">call </span>cpu_clock_end(id_clock_pass)</div><div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;      <span class="keyword">call </span>btcalc(h, g, gv, cs%barotropic_CSp, cs%BT_cont%h_u, cs%BT_cont%h_v)</div><div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;<span class="keywordflow">    endif</span></div><div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;    <span class="keywordflow">if</span> (showcalltree) <span class="keyword">call </span>calltree_waypoint(<span class="stringliteral">&quot;done with continuity[BT_cont] (step_MOM_dyn_split_RK2)&quot;</span>)</div><div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;<span class="keywordflow">  endif</span></div></div><!-- fragment --><p>Subroutine <a class="el" href="../../d5/d7c/namespacemom__barotropic.html#a98cdf3c559146cc9485fcb9daa4cdbca">btstep()</a> sub-cycles the barotropic equations and returns a predicted <code>eta_pred</code> and time-averaged barotropic transport <code>uhbt</code> and <code>vhbt</code>: </p><p class="formulaDsp">
\begin{eqnarray*} uh_{bt} = &lt; U H &gt; \\ vh_{bt} = &lt; V H &gt; \\ \eta_{pred} = \eta^{n-1} + \Delta t \left( \partial_x &lt; U H &gt; + \partial_y &lt; V H &gt; \right) \end{eqnarray*}
</p>
<div class="fragment"><div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;  u_init =&gt; u ; v_init =&gt; v</div><div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;  <span class="keyword">call </span>cpu_clock_begin(id_clock_btstep)</div><div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;  <span class="keywordflow">if</span> (calc_dtbt) <span class="keyword">call </span>set_dtbt(g, gv, cs%barotropic_CSp, eta, cs%pbce)</div><div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;  <span class="keywordflow">if</span> (showcalltree) <span class="keyword">call </span>calltree_enter(<span class="stringliteral">&quot;btstep(), MOM_barotropic.F90&quot;</span>)</div><div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;  <span class="comment">! This is the predictor step call to btstep.</span></div><div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;  <span class="comment">! u_accel_bt = layer zonal accelerations due to barotropic solver</span></div><div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;  <span class="comment">! v_accel_bt = layer meridional accelerations due to barotropic solver</span></div><div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;  <span class="keyword">call </span>btstep(u, v, eta, dt, u_bc_accel, v_bc_accel, &amp;</div><div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;              fluxes, cs%pbce, cs%eta_PF, u_av, v_av, cs%u_accel_bt, &amp;</div><div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;              cs%v_accel_bt, eta_pred, cs%uhbt, cs%vhbt, g, gv, cs%barotropic_CSp,&amp;</div><div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;              cs%visc_rem_u, cs%visc_rem_v, obc=cs%OBC, &amp;</div><div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;              bt_cont = cs%BT_cont, eta_pf_start=eta_pf_start, &amp;</div><div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;              taux_bot=taux_bot, tauy_bot=tauy_bot, &amp;</div><div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;              uh0=uh_ptr, vh0=vh_ptr, u_uh0=u_ptr, v_vh0=v_ptr)</div><div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;  <span class="keyword">call </span>cpu_clock_end(id_clock_btstep)</div><div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;  <span class="keywordflow">if</span> (showcalltree) <span class="keyword">call </span>calltree_leave(<span class="stringliteral">&quot;btstep()&quot;</span>)</div></div><!-- fragment --><p>The barotropic accelerations from the barotropic solver are added to the baroclinic accelerations for a half time-step estimate of flow, <code>up</code> and <code>vp</code>. </p><p class="formulaDsp">
\[ up = u + b_e \Delta t \left( \dot{u}_{bc} + \dot{u}_{bt} \right) \\ vp = v + b_e \Delta t \left( \dot{v}_{bc} + \dot{v}_{bt} \right) \]
</p>
<div class="fragment"><div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;  <span class="comment">! up = u + dt_pred*( u_bc_accel + u_accel_bt )</span></div><div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;  <span class="comment">! vp = v + dt_pred*( v_bc_accel + v_accel_bt )</span></div><div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;  dt_pred = dt * cs%be</div><div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;  <span class="keyword">call </span>cpu_clock_begin(id_clock_mom_update)</div><div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;<span class="comment">!$OMP parallel do default(none) shared(is,ie,js,je,Isq,Ieq,Jsq,Jeq,nz,vp,G,v_init, &amp;</span></div><div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;<span class="comment">!$OMP                                  dt_pred,v_bc_accel,CS,up,u_init,u_bc_accel)</span></div><div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;</div><div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;  <span class="keywordflow">do</span> k=1,nz</div><div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;    <span class="keywordflow">do</span> j=jsq,jeq ; <span class="keywordflow">do</span> i=is,ie</div><div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;      vp(i,j,k) = g%mask2dCv(i,j) * (v_init(i,j,k) + dt_pred * &amp;</div><div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;                      (v_bc_accel(i,j,k) + cs%v_accel_bt(i,j,k)))</div><div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;    <span class="keywordflow">do</span> j=js,je ; <span class="keywordflow">do</span> i=isq,ieq</div><div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;      up(i,j,k) = g%mask2dCu(i,j) * (u_init(i,j,k) + dt_pred  * &amp;</div><div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;                      (u_bc_accel(i,j,k) + cs%u_accel_bt(i,j,k)))</div><div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;<span class="keywordflow">  enddo</span></div><div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;  <span class="keyword">call </span>cpu_clock_end(id_clock_mom_update)</div></div><!-- fragment --><p>The final mid-step values of flow, <code>up</code> and <code>vp</code> are found by re-calculating vertical viscosity coeffients, with a call to <a class="el" href="../../d9/dcb/namespacemom__vert__friction.html#af2cc04944a1f4baa00c574d9ec082eeb" title="Calculate the coupling coefficients (CSa_u and CSa_v) and effective layer thicknesses (CSh_u and CSh_...">vertvisc_coef()</a>, and then applying implicit vertical viscosity using subroutine <a class="el" href="../../d9/dcb/namespacemom__vert__friction.html#afcb3ca5d907b32d50101f90e93d0b160" title="Perform a fully implicit vertical diffusion of momentum. Stress top and bottom boundary conditions ar...">vertvisc()</a>: </p><p class="formulaDsp">
\[ \left[ 1 + \Delta t \partial_z \nu \partial_z \right] up \leftarrow up \\ \left[ 1 + \Delta t \partial_z \nu \partial_z \right] vp \leftarrow vp \]
</p>
<div class="fragment"><div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;  <span class="comment">! up &lt;- up + dt_pred d/dz visc d/dz up</span></div><div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;  <span class="comment">! u_av  &lt;- u_av  + dt_pred d/dz visc d/dz u_av</span></div><div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;  <span class="keyword">call </span>cpu_clock_begin(id_clock_vertvisc)</div><div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;  <span class="keywordflow">if</span> (cs%debug) <span class="keywordflow">then</span></div><div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;    <span class="keyword">call </span>uchksum(up,<span class="stringliteral">&quot;0 before vertvisc: up&quot;</span>,g%HI,haloshift=0)</div><div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;    <span class="keyword">call </span>vchksum(vp,<span class="stringliteral">&quot;0 before vertvisc: vp&quot;</span>,g%HI,haloshift=0)</div><div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;  <span class="keyword">call </span>vertvisc_coef(up, vp, h, fluxes, visc, dt_pred, g, gv, cs%vertvisc_CSp)</div><div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;  <span class="keyword">call </span>vertvisc(up, vp, h, fluxes, visc, dt_pred, cs%OBC, cs%ADp, cs%CDp, g, &amp;</div><div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;                gv, cs%vertvisc_CSp, cs%taux_bot, cs%tauy_bot)</div><div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;  <span class="keywordflow">if</span> (showcalltree) <span class="keyword">call </span>calltree_waypoint(<span class="stringliteral">&quot;done with vertvisc (step_MOM_dyn_split_RK2)&quot;</span>)</div><div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;  <span class="keywordflow">if</span> (g%nonblocking_updates) <span class="keywordflow">then</span></div><div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;    <span class="keyword">call </span>cpu_clock_end(id_clock_vertvisc) ; <span class="keyword">call </span>cpu_clock_begin(id_clock_pass)</div><div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;    <span class="keyword">call </span>start_group_pass(cs%pass_uvp, g%Domain)</div><div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;    <span class="keyword">call </span>cpu_clock_end(id_clock_pass) ; <span class="keyword">call </span>cpu_clock_begin(id_clock_vertvisc)</div><div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;<span class="keywordflow">  endif</span></div><div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;  <span class="keyword">call </span>vertvisc_remnant(visc, cs%visc_rem_u, cs%visc_rem_v, dt_pred, g, gv, cs%vertvisc_CSp)</div><div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;  <span class="keyword">call </span>cpu_clock_end(id_clock_vertvisc)</div></div><!-- fragment --><p>The predictor-step velocities are then used to make a predictor step for layer evolution with a call to <a class="el" href="../../dd/da4/namespacemom__continuity.html#a483dba08c6a9574d7fe814cadccd870e" title="Time steps the layer thicknesses, using a monotonically limited, directionally split PPM scheme...">continuity()</a>: </p><p class="formulaDsp">
\[ hp = h + \Delta t \left( \partial_x ( u h ) + \partial_y ( v h ) \right) \]
</p>
<p> This call also sets time-average flow variables <code>u_av</code> and <code>v_av</code>. </p><p class="formulaDsp">
\[ u_{av} = ? \\ v_{av} = ? \]
</p>
<div class="fragment"><div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;  <span class="comment">! uh = u_av * h</span></div><div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;  <span class="comment">! vh = u_av * h</span></div><div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;  <span class="comment">! hp = h + dt * div . (uh,vh)</span></div><div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;  <span class="keyword">call </span>cpu_clock_begin(id_clock_continuity)</div><div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;  <span class="keyword">call </span>continuity(up, vp, h, hp, uh, vh, dt, g, gv, cs%continuity_CSp, &amp;</div><div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;                  cs%uhbt, cs%vhbt, cs%OBC, cs%visc_rem_u, cs%visc_rem_v, &amp;</div><div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;                  u_av, v_av, bt_cont=cs%BT_cont)</div><div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;  <span class="keyword">call </span>cpu_clock_end(id_clock_continuity)</div><div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;  <span class="keywordflow">if</span> (showcalltree) <span class="keyword">call </span>calltree_waypoint(<span class="stringliteral">&quot;done with continuity (step_MOM_dyn_split_RK2)&quot;</span>)</div></div><!-- fragment --><p>The mid-step layer thicknesses are used during the corrector step: </p><p class="formulaDsp">
\[ h_{av} = \frac{1}{2} ( h + hp ) \]
</p>
<div class="fragment"><div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;  <span class="comment">! h_av = (h + hp)/2</span></div><div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;<span class="comment">!$OMP parallel do default(none) shared(is,ie,js,je,nz,h_av,h,hp)</span></div><div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;  <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> j=js-2,je+2 ; <span class="keywordflow">do</span> i=is-2,ie+2</div><div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;    h_av(i,j,k) = 0.5*(h(i,j,k) + hp(i,j,k))</div><div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;<span class="keywordflow">  enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div></div><!-- fragment --><p>If the gravity waves are being deliberately dampened then the instantaneous mid-step layer thicknesses are found by </p><p class="formulaDsp">
\[ hp = h + b_{gw} \Delta t \left( \partial_x ( u h ) + \partial_y ( v h ) \right) \]
</p>
<p> and the horizontal pressure force re-calculated using <a class="el" href="../../d6/d5c/namespacemom__pressureforce.html#a9f010455182eeaa61c9f01caff250bf8">pressureforce()</a> and the results stored in <code>PFu</code> and <code>PFv</code>:</p>
<div class="fragment"><div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;  <span class="keywordflow">if</span> (cs%begw /= 0.0) <span class="keywordflow">then</span></div><div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;    <span class="comment">! hp &lt;- (1-begw)*h_in + begw*hp</span></div><div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;    <span class="comment">! Back up hp to the value it would have had after a time-step of</span></div><div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;    <span class="comment">! begw*dt.  hp is not used again until recalculated by continuity.</span></div><div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;<span class="comment">!$OMP parallel do default(none) shared(is,ie,js,je,nz,hp,CS,h)</span></div><div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;    <span class="keywordflow">do</span> k=1,nz ; <span class="keywordflow">do</span> j=js-1,je+1 ; <span class="keywordflow">do</span> i=is-1,ie+1</div><div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;      hp(i,j,k) = (1.0-cs%begw)*h(i,j,k) + cs%begw*hp(i,j,k)</div><div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160;<span class="keywordflow">    enddo</span> ;<span class="keywordflow"> enddo</span> ;<span class="keywordflow"> enddo</span></div><div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;</div><div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;    <span class="comment">! PFu = d/dx M(hp,T,S)</span></div><div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160;    <span class="comment">! pbce = dM/deta</span></div><div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160;    <span class="keyword">call </span>cpu_clock_begin(id_clock_pres)</div><div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160;    <span class="keyword">call </span>pressureforce(hp, tv, cs%PFu, cs%PFv, g, gv, &amp;</div><div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160;                       cs%PressureForce_CSp, cs%ALE_CSp, &amp;</div><div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;                       p_surf, cs%pbce, cs%eta_PF)</div><div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;    <span class="keyword">call </span>cpu_clock_end(id_clock_pres)</div><div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;    <span class="keyword">call </span>cpu_clock_begin(id_clock_pass)</div><div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160;    <span class="keyword">call </span>do_group_pass(cs%pass_eta_PF, g%Domain)</div><div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;    <span class="keyword">call </span>cpu_clock_end(id_clock_pass)</div><div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;    <span class="keywordflow">if</span> (showcalltree) <span class="keyword">call </span>calltree_waypoint(<span class="stringliteral">&quot;done with PressureForce[hp=(1-b).h+b.h] (step_MOM_dyn_split_RK2)&quot;</span>)</div><div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;<span class="keywordflow">  endif</span></div></div><!-- fragment --><dl class="todo"><dt><b><a class="el" href="../../dd/da0/todo.html#_todo000003">Todo:</a></b></dt><dd>What is this call to <a class="el" href="../../d5/d7c/namespacemom__barotropic.html#a67277af6e92e3a6824edbbcc85ff9308">btcalc()</a> doing? <div class="fragment"><div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;  <span class="keywordflow">if</span> (bt_cont_bt_thick) <span class="keywordflow">then</span></div><div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;    <span class="keyword">call </span>cpu_clock_begin(id_clock_pass)</div><div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;    <span class="keyword">call </span>do_group_pass(cs%pass_huv, g%Domain)</div><div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;    <span class="keyword">call </span>cpu_clock_end(id_clock_pass)</div><div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;    <span class="keyword">call </span>btcalc(h, g, gv, cs%barotropic_CSp, cs%BT_cont%h_u, cs%BT_cont%h_v)</div><div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;    <span class="keywordflow">if</span> (showcalltree) <span class="keyword">call </span>calltree_waypoint(<span class="stringliteral">&quot;done with btcalc[BT_cont_BT_thick] (step_MOM_dyn_split_RK2)&quot;</span>)</div><div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160;<span class="keywordflow">  endif</span></div></div><!-- fragment --></dd></dl>
<p>The accelerations due to horizontal viscosity are calculated using the time-average flow: </p><p class="formulaDsp">
\[ \dot{u}_{diff} = \nabla_h \cdot A_h \nabla_h &lt;u&gt; \\ \dot{v}_{diff} = \nabla_h \cdot A_h \nabla_h &lt;v&gt; \]
</p>
<div class="fragment"><div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;  <span class="comment">! diffu = horizontal viscosity terms (u_av)</span></div><div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;  <span class="keyword">call </span>cpu_clock_begin(id_clock_horvisc)</div><div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;  <span class="keyword">call </span>horizontal_viscosity(u_av, v_av, h_av, cs%diffu, cs%diffv, &amp;</div><div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;                            meke, varmix, g, gv, cs%hor_visc_CSp, obc=cs%OBC)</div><div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;  <span class="keyword">call </span>cpu_clock_end(id_clock_horvisc)</div><div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;  <span class="keywordflow">if</span> (showcalltree) <span class="keyword">call </span>calltree_waypoint(<span class="stringliteral">&quot;done with horizontal_viscosity (step_MOM_dyn_split_RK2)&quot;</span>)</div></div><!-- fragment --><p>Accelerations due to Coriolis and momentum advection a recalculated by <a class="el" href="../../d8/dd2/namespacemom__coriolisadv.html#a48e46860dad5118d78c8cd7de964e71f" title="Calculates the Coriolis and momentum advection contributions to the acceleration. ...">coradcalc()</a>: </p><p class="formulaDsp">
\begin{eqnarray*} \text{CAu} &amp; = &amp; \frac{f+\zeta}{&lt;h&gt;} (vh) - \partial_x KE \\ \text{CAv} &amp; = &amp; -\frac{f+\zeta}{&lt;h&gt;} (uh) - \partial_y KE \end{eqnarray*}
</p>
<p> where </p><p class="formulaDsp">
\[ \zeta = \partial_x &lt;v&gt; - \partial_y &lt;u&gt; \]
</p>
<p> and </p><p class="formulaDsp">
\[ KE = \frac{1}{2} \left( &lt;u&gt;^2 + &lt;v&gt;^2 \right) \]
</p>
<div class="fragment"><div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;  <span class="comment">! CAu = -(f+zeta_av)/h_av vh + d/dx KE_av</span></div><div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160;  <span class="comment">! CAv =  (f+zeta_av)/h_av uh + d/dy KE_av</span></div><div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160;  <span class="keyword">call </span>cpu_clock_begin(id_clock_cor)</div><div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;  <span class="keyword">call </span>coradcalc(u_av, v_av, h_av, uh, vh, cs%CAu, cs%CAv, cs%OBC, cs%ADp, &amp;</div><div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;                 g, gv, cs%CoriolisAdv_CSp)</div><div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160;  <span class="keyword">call </span>cpu_clock_end(id_clock_cor)</div><div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160;  <span class="keywordflow">if</span> (showcalltree) <span class="keyword">call </span>calltree_waypoint(<span class="stringliteral">&quot;done with CorAdCalc (step_MOM_dyn_split_RK2)&quot;</span>)</div></div><!-- fragment --></div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
